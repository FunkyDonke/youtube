<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTube Clone</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- FontAwesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- React & ReactDOM CDN -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  
  <!-- Babel for JSX compilation in browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- YouTube Iframe API -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    window.ytApiLoaded = false;
    function onYouTubeIframeAPIReady() {
      window.ytApiLoaded = true;
      window.dispatchEvent(new Event('yt-api-ready'));
    }
  </script>
  <style>
    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #555; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #888; }
  </style>
</head>
<body class="bg-[#0f0f0f] text-white font-sans">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const initialVideos = [
      {
        id: 'aqz-KE-bpKQ', videoId: 'aqz-KE-bpKQ', listId: null, type: 'video', provider: 'youtube',
        title: 'Big Buck Bunny 60fps 4K - Official Blender Foundation Short Film', channel: 'Blender', views: '12M views',
        thumbnail: 'https://img.youtube.com/vi/aqz-KE-bpKQ/hqdefault.jpg', channelAvatar: 'https://ui-avatars.com/api/?name=Blender&background=random',
      },
      {
        id: 'LXb3EKWsInQ', videoId: 'LXb3EKWsInQ', listId: null, type: 'video', provider: 'youtube',
        title: 'COSTA RICA IN 4K 60fps HDR (ULTRA HD)', channel: 'Jacob + Katie Schwarz', views: '150M views',
        thumbnail: 'https://img.youtube.com/vi/LXb3EKWsInQ/hqdefault.jpg', channelAvatar: 'https://ui-avatars.com/api/?name=Jacob&background=random',
      },
      {
        id: 'w7ejDZ8SWv8', videoId: 'w7ejDZ8SWv8', listId: null, type: 'video', provider: 'youtube',
        title: 'React JS Crash Course for Beginners', channel: 'Code Step By Step', views: '2.5M views',
        thumbnail: 'https://img.youtube.com/vi/w7ejDZ8SWv8/hqdefault.jpg', channelAvatar: 'https://ui-avatars.com/api/?name=Code&background=random',
      }
    ];

    function parseMediaInput(input) {
      let videoId = null;
      let listId = null;
      let driveId = null;
      let title = '';
      let urlStr = input.replace(/&amp;/g, '&');

      const iframeMatch = urlStr.match(/src=["'](.*?)["']/);
      if (iframeMatch) urlStr = iframeMatch[1];
      const titleMatch = input.match(/title=["'](.*?)["']/);
      if (titleMatch) title = titleMatch[1];
      
      if(title.toLowerCase() === 'youtube video player' || title.toLowerCase() === 'custom video') title = ''; 

      try {
        if (urlStr.includes('drive.google.com')) {
            const driveMatch = urlStr.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (driveMatch) driveId = driveMatch[1];
            return { videoId, listId, driveId, title };
        }

        if (!urlStr.startsWith('http') && !urlStr.startsWith('//')) urlStr = 'https://' + urlStr;
        else if (urlStr.startsWith('//')) urlStr = 'https:' + urlStr;
        
        const url = new URL(urlStr);
        if (url.searchParams.has('v')) videoId = url.searchParams.get('v');
        if (url.searchParams.has('list')) listId = url.searchParams.get('list');
        
        if (url.pathname.startsWith('/embed/')) {
          const pathParts = url.pathname.split('/');
          const id = pathParts[pathParts.length - 1];
          if (id && id !== 'videoseries') videoId = id;
        } else if (url.hostname.includes('youtu.be')) {
          videoId = url.pathname.slice(1);
        }
      } catch (e) {
        console.error("URL Error", e);
      }
      return { videoId, listId, driveId, title };
    }

    // Auto Thumbnail Generator for Local Videos
    const generateThumbnail = (file) => {
        return new Promise((resolve) => {
            const video = document.createElement('video');
            video.preload = 'metadata';
            video.src = URL.createObjectURL(file);
            video.muted = true;
            video.playsInline = true;
            
            video.addEventListener('loadedmetadata', () => {
                video.currentTime = Math.min(1, video.duration / 2 || 0); // ১ সেকেন্ড অথবা মাঝখানের ফ্রেম
            });

            video.addEventListener('seeked', () => {
                try {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth || 640;
                    canvas.height = video.videoHeight || 360;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg'));
                } catch (e) {
                    resolve('https://placehold.co/640x360/10B981/FFFFFF/png?text=Local+Video');
                }
                URL.revokeObjectURL(video.src);
            });

            video.addEventListener('error', () => {
                resolve('https://placehold.co/640x360/10B981/FFFFFF/png?text=Local+Video');
                URL.revokeObjectURL(video.src);
            });
        });
    };

    function HoverPlayer({ video, savedTime, onPlay }) {
        const playerContainerRef = useRef(null);
        const playerRef = useRef(null);

        // Local Video Hover Logic with Controls & Resume
        if (video.provider === 'local') {
            let blobUrl = video.blobUrl;
            let currentId = video.id;
            
            if (video.type === 'local_playlist' && video.videoObjects?.length > 0) {
                blobUrl = video.videoObjects[0].blobUrl;
                currentId = video.videoObjects[0].id;
            }

            return (
                <div className="absolute inset-0 z-10 bg-black rounded-lg overflow-hidden group/player pointer-events-auto">
                    <video 
                        src={blobUrl} 
                        className="w-full h-full object-cover pointer-events-auto" 
                        autoPlay 
                        muted 
                        controls
                        onLoadedMetadata={(e) => {
                             const times = JSON.parse(localStorage.getItem('ytCloneTimes') || '{}');
                             if (times[currentId] && times[currentId] > 0) {
                                 e.target.currentTime = times[currentId];
                             }
                        }}
                    />
                    <div 
                        className="absolute top-0 left-0 right-0 bottom-[45px] z-20 cursor-pointer"
                        onClick={(e) => {
                            e.stopPropagation();
                            onPlay();
                        }}
                    ></div>
                </div>
            );
        }

        // YouTube Hover Logic
        useEffect(() => {
            if (!window.YT || !video.videoId) return;
            
            const playerDiv = document.createElement('div');
            playerDiv.style.width = '100%';
            playerDiv.style.height = '100%';
            playerContainerRef.current.appendChild(playerDiv);

            playerRef.current = new window.YT.Player(playerDiv, {
                videoId: video.videoId,
                playerVars: { 
                    autoplay: 1, 
                    mute: 1, 
                    start: savedTime || 0, 
                    controls: 1, 
                    modestbranding: 1, 
                    playsinline: 1, 
                    rel: 0,
                    showinfo: 0,
                    fs: 0
                }
            });

            return () => {
                if (playerRef.current && typeof playerRef.current.destroy === 'function') {
                    playerRef.current.destroy();
                }
                if (playerContainerRef.current) {
                    playerContainerRef.current.innerHTML = '';
                }
            };
        }, [video.videoId, savedTime]);

        return (
            <div className="absolute inset-0 z-10 bg-black rounded-lg overflow-hidden group/player pointer-events-auto">
                <div className="w-full h-full pointer-events-auto" ref={playerContainerRef}></div>
                <div 
                    className="absolute top-0 left-0 right-0 bottom-[45px] z-20 cursor-pointer"
                    onClick={(e) => {
                        e.stopPropagation();
                        onPlay();
                    }}
                ></div>
            </div>
        );
    }

    function SidebarToggle({ icon, label, isExpanded, onToggle, children, isOpen, scrollable }) {
        return (
            <>
                <div 
                    onClick={onToggle} 
                    className={`flex items-center ${isOpen ? 'justify-start px-3' : 'justify-center flex-col'} py-2.5 my-1 rounded-xl cursor-pointer transition-colors ${isExpanded ? 'bg-white/10 font-bold' : 'hover:bg-white/10'}`}
                >
                    <div className={`flex items-center justify-center ${isOpen ? 'mr-4' : 'mb-1'} ${isExpanded ? 'text-white' : 'text-gray-200'}`}>{icon}</div>
                    <span className={`${isOpen ? 'text-sm' : 'text-[10px]'} flex-1 ${isExpanded ? 'text-white font-semibold' : 'text-gray-200'} whitespace-nowrap overflow-hidden text-ellipsis`}>{label}</span>
                    {isOpen && <i className={`fas fa-chevron-down text-xs text-gray-400 transition-transform ${isExpanded ? 'rotate-180' : ''}`}></i>}
                </div>
                {isExpanded && isOpen && (
                    <div className={`flex flex-col gap-2 px-2 mt-1 mb-3 ${scrollable ? 'max-h-[260px] overflow-y-auto custom-scrollbar pr-1' : ''}`}>
                        {children}
                    </div>
                )}
            </>
        );
    }

    function App() {
      const [videos, setVideos] = useState(() => {
        const saved = localStorage.getItem('ytCloneVideos');
        // Filter out local videos on initial load because Blob URLs expire on reload
        let parsed = saved ? JSON.parse(saved) : initialVideos;
        return parsed.filter(v => v.provider !== 'local');
      });

      const [currentVideo, setCurrentVideo] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [isSidebarOpen, setIsSidebarOpen] = useState(true);
      
      const [watchHistory, setWatchHistory] = useState([]);
      const [lastWatched, setLastWatched] = useState(null);
      
      // Sidebar Dropdown States
      const [isAllVideosExpanded, setIsAllVideosExpanded] = useState(false);
      const [isAllPlaylistsExpanded, setIsAllPlaylistsExpanded] = useState(false);
      const [isCurrentPlaylistExpanded, setIsCurrentPlaylistExpanded] = useState(true);
      const [isHistoryExpanded, setIsHistoryExpanded] = useState(false);
      
      // Grid Size Control State
      const [gridCols, setGridCols] = useState(4);

      const [playlistQueue, setPlaylistQueue] = useState([]);
      const [currentPlaylistIndex, setCurrentPlaylistIndex] = useState(0);
      const [fetchedMeta, setFetchedMeta] = useState({});

      const [alertState, setAlertState] = useState({ isOpen: false, message: '' });
      const [confirmState, setConfirmState] = useState({ isOpen: false, message: '', targetId: null });

      const [isAddModalOpen, setIsAddModalOpen] = useState(false);
      const [isLocalModalOpen, setIsLocalModalOpen] = useState(false);
      
      const [newMediaInput, setNewMediaInput] = useState({ link: '', title: '', channel: '' });
      const [isCreateListModalOpen, setIsCreateListModalOpen] = useState(false);
      const [newListTitle, setNewListTitle] = useState('');
      const [selectedVideoIds, setSelectedVideoIds] = useState([]);

      const [isMiniplayer, setIsMiniplayer] = useState(false);
      const [isTheaterMode, setIsTheaterMode] = useState(false);
      const [playerRect, setPlayerRect] = useState(null); 
      const [isDragging, setIsDragging] = useState(false);
      const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
      const [resizeState, setResizeState] = useState({ active: false, dir: null, startX: 0, startY: 0, startLeft: 0, startTop: 0, startWidth: 0, startHeight: 0 });

      const [progressData, setProgressData] = useState({ times: {}, durations: {} });
      const [hoveredVideo, setHoveredVideo] = useState(null);
      const hoverTimeout = useRef(null);

      const [ytReady, setYtReady] = useState(window.ytApiLoaded);
      const ytContainerRef = useRef(null);
      const playerRef = useRef(null);
      const timeIntervalRef = useRef(null);
      const localVideoRef = useRef(null);
      
      const [autoPlay, setAutoPlay] = useState(false); 

      const currentVideoData = currentVideo ? (videos.find(v => v.id === currentVideo.id) || currentVideo) : null;

      useEffect(() => {
        const savedHistory = localStorage.getItem('ytCloneHistory');
        const savedLastWatched = localStorage.getItem('ytCloneLastWatched');
        if (savedHistory) {
            let parsedHistory = JSON.parse(savedHistory).filter(v => v.provider !== 'local');
            setWatchHistory(parsedHistory);
        }
        if (savedLastWatched) {
            const parsed = JSON.parse(savedLastWatched);
            if (parsed.provider !== 'local') {
                setLastWatched(parsed);
                setCurrentVideo(parsed);
                const w = 384;
                const h = w * (9/16) + 40;
                setPlayerRect({ left: window.innerWidth - w - 24, top: window.innerHeight - h - 24, width: w, height: h });
                setIsMiniplayer(true);
                setAutoPlay(false);
            }
        }

        setProgressData({
            times: JSON.parse(localStorage.getItem('ytCloneTimes') || '{}'),
            durations: JSON.parse(localStorage.getItem('ytCloneDurations') || '{}')
        });

        const handleReady = () => setYtReady(true);
        window.addEventListener('yt-api-ready', handleReady);
        return () => window.removeEventListener('yt-api-ready', handleReady);
      }, []);

      useEffect(() => {
        let isMounted = true;
        const fetchMissingTitles = () => {
            if(currentVideoData?.provider === 'local') return;
            playlistQueue.forEach(vidId => {
                const existsLocally = videos.find(v => v.videoId === vidId);
                if (!existsLocally) {
                    setFetchedMeta(prev => {
                        if (prev[vidId]) return prev;
                        fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${vidId}`)
                            .then(res => res.json())
                            .then(data => {
                                if (data && data.title && isMounted) {
                                    setFetchedMeta(current => ({ ...current, [vidId]: { title: data.title, channel: data.author_name } }));
                                }
                            }).catch(() => {});
                        return { ...prev, [vidId]: { loading: true } };
                    });
                }
            });
        };

        if (playlistQueue.length > 0) fetchMissingTitles();
        return () => { isMounted = false; };
      }, [playlistQueue, videos, currentVideoData]);

      const handleMouseEnter = (video) => {
          if (video.type === 'video' && video.provider !== 'gdrive' && (video.videoId || video.blobUrl)) {
              hoverTimeout.current = setTimeout(() => {
                  setHoveredVideo(video.id);
              }, 600); 
          }
      };

      const handleMouseLeave = () => {
          if (hoverTimeout.current) clearTimeout(hoverTimeout.current);
          setHoveredVideo(null);
      };

      // Handle Local File & Folder Uploads (with Real Thumbnail Gen & Correct Filtering)
      const handleLocalFiles = async (e, isFolder) => {
          const files = Array.from(e.target.files).filter(f => f.type.startsWith('video/'));
          if (files.length === 0) {
              setAlertState({ isOpen: true, message: 'কোনো সঠিক ভিডিও ফাইল পাওয়া যায়নি!' });
              return;
          }

          setIsLocalModalOpen(false); // Close modal
          
          // Temporary loading message
          setTimeout(() => {
              setAlertState({ isOpen: true, message: 'ফাইলগুলো প্রসেস করা হচ্ছে, দয়া করে একটু অপেক্ষা করুন...' });
          }, 100);

          let updated = [...videos];

          if (isFolder && files.length > 1) {
              const folderName = files[0].webkitRelativePath.split('/')[0] || 'লোকাল ফোল্ডার';
              const playlistId = 'local-folder-' + Date.now();
              
              const vidsWithThumbs = [];
              for(let i=0; i<files.length; i++){
                  const f = files[i];
                  const thumb = await generateThumbnail(f);
                  vidsWithThumbs.push({
                      id: playlistId + '-vid-' + i,
                      videoId: playlistId + '-vid-' + i,
                      title: f.name.replace(/\.[^/.]+$/, ""),
                      channel: 'Local Storage',
                      views: 'Local File',
                      thumbnail: thumb,
                      type: 'video',
                      provider: 'local',
                      fileObj: f,
                      blobUrl: URL.createObjectURL(f)
                  });
              }

              const playlist = {
                  id: playlistId,
                  listId: playlistId,
                  title: folderName,
                  channel: 'Local Storage',
                  views: `${vidsWithThumbs.length} ভিডিও`,
                  thumbnail: vidsWithThumbs[0]?.thumbnail || 'https://placehold.co/640x360/3B82F6/FFFFFF/png?text=Local+Folder',
                  type: 'local_playlist',
                  provider: 'local',
                  videoObjects: vidsWithThumbs
              };
              
              // Only add PLAYLIST to videos array, not the individual videos (keeps homepage clean)
              updated = [playlist, ...videos];
          } else {
              const newVideos = [];
              for(let i=0; i<files.length; i++){
                  const f = files[i];
                  const thumb = await generateThumbnail(f);
                  newVideos.push({
                      id: 'local-vid-' + Date.now() + '-' + i,
                      videoId: 'local-vid-' + Date.now() + '-' + i,
                      title: f.name.replace(/\.[^/.]+$/, ""),
                      channel: 'Local Storage',
                      views: 'Local File',
                      thumbnail: thumb,
                      type: 'video',
                      provider: 'local',
                      fileObj: f,
                      blobUrl: URL.createObjectURL(f)
                  });
              }
              updated = [...newVideos, ...videos];
          }

          setVideos(updated);
          
          // Save only non-local videos to localStorage
          const storable = updated.filter(v => v.provider !== 'local');
          localStorage.setItem('ytCloneVideos', JSON.stringify(storable));
          
          setAlertState({ isOpen: false, message: '' }); // clear processing
      };

      // Main YouTube Player Initialization
      useEffect(() => {
        if (!ytReady) return;
        
        if (!currentVideo) {
            if (playerRef.current) {
                playerRef.current.destroy();
                playerRef.current = null;
            }
            return;
        }

        // Skip YouTube player for Local and GDrive videos
        if (currentVideo.provider === 'gdrive' || currentVideo.driveId || currentVideo.provider === 'local') {
            if (playerRef.current && typeof playerRef.current.pauseVideo === 'function') {
                playerRef.current.pauseVideo();
            }
            return;
        }

        const currentTimes = JSON.parse(localStorage.getItem('ytCloneTimes') || '{}');
        const startSeconds = currentTimes[currentVideo.id] || 0;

        const savedIndexes = JSON.parse(localStorage.getItem('ytClonePlaylistIndexes') || '{}');
        const startIndex = savedIndexes[currentVideo.id] || 0;

        const isPlaylist = currentVideo.type === 'playlist';
        const isLocalPlaylist = currentVideo.type === 'local_playlist';
        
        let playerVars = { autoplay: autoPlay ? 1 : 0, start: startSeconds, enablejsapi: 1, playsinline: 1 };

        if (!playerRef.current) {
            if (ytContainerRef.current) {
                const playerDiv = document.createElement('div');
                ytContainerRef.current.appendChild(playerDiv);

                playerRef.current = new window.YT.Player(playerDiv, {
                    height: '100%', width: '100%',
                    videoId: isLocalPlaylist ? currentVideo.videoIds[0] : (currentVideo.videoId || ''),
                    playerVars: playerVars,
                    events: {
                        onReady: (e) => { 
                            if (isPlaylist) {
                                if (autoPlay) e.target.loadPlaylist({ list: currentVideo.listId, listType: 'playlist', index: startIndex, startSeconds: startSeconds });
                                else e.target.cuePlaylist({ list: currentVideo.listId, listType: 'playlist', index: startIndex, startSeconds: startSeconds });
                            } else if (isLocalPlaylist) {
                                if (autoPlay) e.target.loadPlaylist({ playlist: currentVideo.videoIds, index: startIndex, startSeconds: startSeconds });
                                else e.target.cuePlaylist({ playlist: currentVideo.videoIds, index: startIndex, startSeconds: startSeconds });
                            } else {
                                if (autoPlay) e.target.playVideo();
                            }
                        },
                        onStateChange: (e) => {
                            if (e.data === window.YT.PlayerState.PLAYING || e.data === window.YT.PlayerState.UNSTARTED || e.data === window.YT.PlayerState.CUED) {
                                if (currentVideo.type.includes('playlist')) {
                                    const queue = e.target.getPlaylist();
                                    if (queue && queue.length > 0) {
                                        setPlaylistQueue(queue);
                                        const idx = e.target.getPlaylistIndex();
                                        if (idx !== null && idx !== undefined && idx !== -1) {
                                            setCurrentPlaylistIndex(idx);
                                        }
                                        
                                        setVideos(prev => {
                                            let changed = false;
                                            const updated = prev.map(v => {
                                                if (v.id === currentVideo.id) {
                                                    const expectedThumb = `https://img.youtube.com/vi/${queue[0]}/hqdefault.jpg`;
                                                    if (v.thumbnail !== expectedThumb) {
                                                        changed = true;
                                                        return { ...v, thumbnail: expectedThumb };
                                                    }
                                                }
                                                return v;
                                            });
                                            if (changed) {
                                                const storable = updated.filter(v => v.provider !== 'local');
                                                localStorage.setItem('ytCloneVideos', JSON.stringify(storable));
                                            }
                                            return changed ? updated : prev;
                                        });
                                    }
                                }
                            }

                            if (e.data === window.YT.PlayerState.PLAYING) {
                                if (currentVideo.type.includes('playlist')) {
                                    const currentIdx = e.target.getPlaylistIndex();
                                    if (currentIdx !== null && currentIdx !== undefined && currentIdx !== -1) {
                                        const indexes = JSON.parse(localStorage.getItem('ytClonePlaylistIndexes') || '{}');
                                        if (indexes[currentVideo.id] !== currentIdx) {
                                            indexes[currentVideo.id] = currentIdx;
                                            localStorage.setItem('ytClonePlaylistIndexes', JSON.stringify(indexes));
                                            
                                            const times = JSON.parse(localStorage.getItem('ytCloneTimes') || '{}');
                                            times[currentVideo.id] = 0;
                                            localStorage.setItem('ytCloneTimes', JSON.stringify(times));
                                        }
                                    }
                                } else {
                                    const vData = e.target.getVideoData();
                                    if (vData && vData.title) {
                                        setVideos(prev => {
                                            let changed = false;
                                            const updated = prev.map(v => {
                                                if (v.id === currentVideo.id && (v.title === 'YouTube Video' || v.title === 'Custom Video' || v.title === '')) {
                                                    changed = true;
                                                    return { ...v, title: vData.title };
                                                }
                                                return v;
                                            });
                                            if(changed) {
                                                const storable = updated.filter(v => v.provider !== 'local');
                                                localStorage.setItem('ytCloneVideos', JSON.stringify(storable));
                                            }
                                            return changed ? updated : prev;
                                        });
                                    }
                                }

                                timeIntervalRef.current = setInterval(() => {
                                    if (playerRef.current && playerRef.current.getCurrentTime && playerRef.current.getDuration) {
                                        const time = Math.floor(playerRef.current.getCurrentTime());
                                        const duration = Math.floor(playerRef.current.getDuration());
                                        
                                        const times = JSON.parse(localStorage.getItem('ytCloneTimes') || '{}');
                                        const durations = JSON.parse(localStorage.getItem('ytCloneDurations') || '{}');
                                        
                                        times[currentVideo.id] = time;
                                        durations[currentVideo.id] = duration;
                                        
                                        localStorage.setItem('ytCloneTimes', JSON.stringify(times));
                                        localStorage.setItem('ytCloneDurations', JSON.stringify(durations));

                                        setProgressData({ times, durations }); 
                                    }
                                }, 1000);
                            } else {
                                clearInterval(timeIntervalRef.current);
                            }
                        }
                    }
                });
            }
        } else {
            if (isPlaylist) {
                if (autoPlay) playerRef.current.loadPlaylist({ list: currentVideo.listId, listType: 'playlist', index: startIndex, startSeconds });
                else playerRef.current.cuePlaylist({ list: currentVideo.listId, listType: 'playlist', index: startIndex, startSeconds });
            } else if (isLocalPlaylist) {
                if (autoPlay) playerRef.current.loadPlaylist({ playlist: currentVideo.videoIds, index: startIndex, startSeconds });
                else playerRef.current.cuePlaylist({ playlist: currentVideo.videoIds, index: startIndex, startSeconds });
            } else {
                if (autoPlay) playerRef.current.loadVideoById({ videoId: currentVideo.videoId, startSeconds });
                else playerRef.current.cueVideoById({ videoId: currentVideo.videoId, startSeconds });
            }
        }

        return () => clearInterval(timeIntervalRef.current);
      }, [currentVideo, ytReady, autoPlay]);

      const activateMiniplayer = () => {
        if (!playerRect) {
            const w = 384;
            const h = w * (9/16) + 40;
            setPlayerRect({ left: window.innerWidth - w - 24, top: window.innerHeight - h - 24, width: w, height: h });
        }
        setIsMiniplayer(true);
      };

      const playVideo = (video) => {
        if (currentVideo && currentVideo.id === video.id) {
            setIsMiniplayer(false);
            setAutoPlay(true);
            if (video.provider !== 'local' && playerRef.current && typeof playerRef.current.playVideo === 'function') {
                playerRef.current.playVideo();
            }
            if (video.provider === 'local' && localVideoRef.current) {
                localVideoRef.current.play();
            }
            return;
        }

        setAutoPlay(true); 
        setCurrentVideo(video);
        setIsMiniplayer(false); 
        
        // Manual logic for Local Playlist Queue
        if (video.provider === 'local' && video.type === 'local_playlist') {
            const savedIndexes = JSON.parse(localStorage.getItem('ytClonePlaylistIndexes') || '{}');
            const startIndex = savedIndexes[video.id] || 0;
            
            setPlaylistQueue(video.videoObjects.map(v => v.id));
            setCurrentPlaylistIndex(startIndex);
            setIsCurrentPlaylistExpanded(true);
        } else if (video.provider !== 'local') {
            // Let YT player handle its own queue setup mostly, but clear local states
            setPlaylistQueue([]); 
            setCurrentPlaylistIndex(0);
            setIsCurrentPlaylistExpanded(true); 
        }

        const updatedHistory = [video, ...watchHistory.filter(v => v.id !== video.id)].slice(0, 20);
        setWatchHistory(updatedHistory);
        
        // Only save non-local videos to history to prevent broken links on reload
        const storableHistory = updatedHistory.filter(v => v.provider !== 'local');
        localStorage.setItem('ytCloneHistory', JSON.stringify(storableHistory));
        
        if (video.provider !== 'local') {
            setLastWatched(video);
            localStorage.setItem('ytCloneLastWatched', JSON.stringify(video));
        }
      };

      const deleteMedia = (e, id) => {
        e.stopPropagation();
        setConfirmState({ isOpen: true, message: 'আপনি কি নিশ্চিত যে এই আইটেমটি ডিলিট করতে চান?', targetId: id });
      };

      const executeDelete = () => {
        const updatedVideos = videos.filter(v => v.id !== confirmState.targetId);
        setVideos(updatedVideos);
        
        const storable = updatedVideos.filter(v => v.provider !== 'local');
        localStorage.setItem('ytCloneVideos', JSON.stringify(storable));
        
        if(currentVideo?.id === confirmState.targetId) {
            setCurrentVideo(null);
            setIsMiniplayer(false);
        }
        setConfirmState({ isOpen: false, message: '', targetId: null });
      };

      const handleAddSubmit = (e) => {
        e.preventDefault();
        const { videoId, listId, driveId, title: extractedTitle } = parseMediaInput(newMediaInput.link);
        
        if (!videoId && !listId && !driveId) {
            setAlertState({ isOpen: true, message: 'দয়া করে একটি সঠিক ইউটিউব বা গুগল ড্রাইভ লিংক/এমবেড কোড দিন।' });
            return;
        }

        const id = driveId ? driveId : (listId ? listId : videoId);
        const type = driveId ? 'video' : (listId ? 'playlist' : 'video');
        const provider = driveId ? 'gdrive' : 'youtube';
        
        let finalTitle = newMediaInput.title || extractedTitle;
        if (!finalTitle) finalTitle = driveId ? 'Google Drive Video' : (type === 'playlist' ? 'YouTube Playlist' : 'YouTube Video');

        let thumbnail = 'https://placehold.co/640x360/222222/FFFFFF/png?text=Media';
        if (driveId) thumbnail = 'https://placehold.co/640x360/1a73e8/FFFFFF/png?text=Google+Drive+Video';
        else if (videoId) thumbnail = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
        else if (listId) thumbnail = 'https://placehold.co/640x360/222222/FFFFFF/png?text=YouTube+Playlist';

        const newMedia = {
            id: id, videoId, listId, driveId, type, provider, title: finalTitle,
            channel: newMediaInput.channel || 'Added by User', views: '0 views', thumbnail,
            channelAvatar: `https://ui-avatars.com/api/?name=${newMediaInput.channel || 'User'}&background=random`,
        };

        const updatedVideos = [newMedia, ...videos];
        setVideos(updatedVideos);
        
        const storable = updatedVideos.filter(v => v.provider !== 'local');
        localStorage.setItem('ytCloneVideos', JSON.stringify(storable));
        
        setIsAddModalOpen(false);
        setNewMediaInput({ link: '', title: '', channel: '' });
      };

      const handleCreatePlaylist = (e) => {
        e.preventDefault();
        if(selectedVideoIds.length === 0) {
            setAlertState({ isOpen: true, message: 'অন্তত একটি ভিডিও নির্বাচন করুন।' });
            return;
        }
        
        const firstVid = videos.find(v => v.videoId === selectedVideoIds[0]);
        const newPlaylist = {
            id: 'local-list-' + Date.now(), type: 'local_playlist', provider: 'youtube', title: newListTitle || 'My Playlist',
            videoIds: selectedVideoIds, thumbnail: firstVid ? firstVid.thumbnail : 'https://placehold.co/640x360/222222/FFFFFF/png?text=Playlist',
            channel: 'Created by You', channelAvatar: 'https://ui-avatars.com/api/?name=User&background=random',
            views: selectedVideoIds.length + ' videos'
        };
        
        const updated = [newPlaylist, ...videos];
        setVideos(updated);
        
        const storable = updated.filter(v => v.provider !== 'local');
        localStorage.setItem('ytCloneVideos', JSON.stringify(storable));
        
        setIsCreateListModalOpen(false);
        setNewListTitle('');
        setSelectedVideoIds([]);
      };

      const filteredVideos = videos.filter(video => video.title.toLowerCase().includes(searchQuery.toLowerCase()) || video.channel.toLowerCase().includes(searchQuery.toLowerCase()));

      let displayTitle = currentVideoData?.title || '';
      let displayChannel = currentVideoData?.channel || '';
      let displayAvatar = currentVideoData?.channelAvatar || '';

      if (currentVideoData?.type?.includes('playlist') && playlistQueue.length > 0) {
          const activeVidId = playlistQueue[currentPlaylistIndex];
          
          if (currentVideoData.provider === 'local') {
              const activeLocalVid = currentVideoData.videoObjects?.[currentPlaylistIndex];
              if (activeLocalVid) {
                  displayTitle = activeLocalVid.title;
                  displayChannel = activeLocalVid.channel;
                  displayAvatar = activeLocalVid.thumbnail;
              }
          } else if (activeVidId) {
              const localVidInfo = videos.find(v => v.videoId === activeVidId);
              const meta = fetchedMeta[activeVidId];

              if (localVidInfo) {
                  displayTitle = localVidInfo.title;
                  displayChannel = localVidInfo.channel;
                  displayAvatar = localVidInfo.channelAvatar;
              } else if (meta && meta.title) {
                  displayTitle = meta.title;
                  displayChannel = meta.channel;
              } else if (meta && meta.loading) {
                  displayTitle = 'লোড হচ্ছে...';
              } else {
                  displayTitle = `ভিডিও ${currentPlaylistIndex + 1}`;
              }
          }
      }

      const handleDragStart = (e) => {
        if (e.target.closest('button') || e.target.tagName.toLowerCase() === 'input') return;
        setIsDragging(true);
        const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
        setDragOffset({ x: clientX - playerRect.left, y: clientY - playerRect.top });
      };

      const handleResizeStart = (e, dir) => {
        e.stopPropagation(); e.preventDefault();
        const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
        setResizeState({ active: true, dir, startX: clientX, startY: clientY, startLeft: playerRect.left, startTop: playerRect.top, startWidth: playerRect.width, startHeight: playerRect.height });
      };

      useEffect(() => {
        const handleMove = (e) => {
          const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
          const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
          
          if (isDragging && playerRect) {
            setPlayerRect(prev => ({ ...prev, left: clientX - dragOffset.x, top: clientY - dragOffset.y }));
          } else if (resizeState.active) {
            const dx = clientX - resizeState.startX, dy = clientY - resizeState.startY;
            let { startLeft, startTop, startWidth, startHeight, dir } = resizeState;
            let newWidth = startWidth, newLeft = startLeft, newTop = startTop;

            if (dir.includes('e')) newWidth = startWidth + dx;
            else if (dir.includes('w')) { newWidth = startWidth - dx; newLeft = startLeft + dx; } 
            
            if (dir.includes('n')) {
                const videoH = (startHeight - dy) - 40;
                newWidth = videoH * (16/9);
                newTop = startTop + dy;
                newLeft = startLeft + (startWidth - newWidth) / 2;
            } else if (dir.includes('s')) {
                const videoH = (startHeight + dy) - 40;
                newWidth = videoH * (16/9);
                newLeft = startLeft + (startWidth - newWidth) / 2;
            }

            if (newWidth < 250) { newWidth = 250; if (dir.includes('w')) newLeft -= (250 - newWidth); }
            if (newWidth > 800) { newWidth = 800; if (dir.includes('w')) newLeft += (newWidth - 800); }

            const newHeight = newWidth * (9/16) + 40;
            if (dir.includes('n')) newTop = startTop + (startHeight - newHeight);
            setPlayerRect({ left: newLeft, top: newTop, width: newWidth, height: newHeight });
          }
        };

        const handleUp = () => { setIsDragging(false); setResizeState(prev => ({ ...prev, active: false })); };

        if (isDragging || resizeState.active) {
          window.addEventListener('mousemove', handleMove); window.addEventListener('mouseup', handleUp);
          window.addEventListener('touchmove', handleMove, { passive: false }); window.addEventListener('touchend', handleUp);
        }
        return () => {
          window.removeEventListener('mousemove', handleMove); window.removeEventListener('mouseup', handleUp);
          window.removeEventListener('touchmove', handleMove); window.removeEventListener('touchend', handleUp);
        };
      }, [isDragging, resizeState, dragOffset, playerRect]);

      let gridClass = "grid gap-x-4 gap-y-8 ";
      if (gridCols === 1) gridClass += "grid-cols-1";
      else if (gridCols === 2) gridClass += "grid-cols-1 sm:grid-cols-2";
      else if (gridCols === 3) gridClass += "grid-cols-1 sm:grid-cols-2 lg:grid-cols-3";
      else if (gridCols === 4) gridClass += "grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4";
      else if (gridCols === 5) gridClass += "grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5";
      else gridClass += "grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6";

      return (
        <div className="min-h-screen flex flex-col relative overflow-hidden bg-[#0f0f0f]">
          <header className="flex items-center justify-between px-4 py-2 sticky top-0 bg-[#0f0f0f] z-40 h-16 border-b border-white/10">
            <div className="flex items-center gap-4">
              <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 hover:bg-white/10 rounded-full transition-colors">
                <i className="fas fa-bars text-xl"></i>
              </button>
              <div className="flex items-center gap-2 cursor-pointer" onClick={() => { setCurrentVideo(null); setIsMiniplayer(false); }}>
                <i className="fab fa-youtube text-red-600 text-3xl"></i>
                <span className="text-xl font-bold tracking-tighter hidden sm:block">YouTube</span>
              </div>
            </div>

            <div className="flex-1 max-w-xl flex items-center ml-4 mr-4">
              <div className="flex w-full bg-[#121212] border border-white/20 rounded-full overflow-hidden focus-within:border-blue-500">
                <input 
                  type="text" 
                  placeholder="অনুসন্ধান করুন..." 
                  className="w-full bg-transparent px-4 py-2 outline-none text-white placeholder-gray-400"
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                />
                <button className="px-5 bg-white/10 hover:bg-white/20 transition-colors border-l border-white/20">
                  <i className="fas fa-search text-gray-300"></i>
                </button>
              </div>
            </div>

            <div className="flex items-center gap-2 sm:gap-3">
              {(!currentVideo || isMiniplayer) && (
                <div className="hidden md:flex items-center gap-2 bg-[#212121] px-2 py-1 rounded-full border border-gray-700 mr-1">
                  <button onClick={() => setGridCols(Math.max(1, gridCols - 1))} className="text-gray-300 hover:text-white hover:bg-white/10 w-6 h-6 rounded flex items-center justify-center transition" title="ভিডিও বড় করুন">
                      <i className="fas fa-plus text-[10px]"></i>
                  </button>
                  <div className="w-px h-3 bg-gray-600"></div>
                  <button onClick={() => setGridCols(Math.min(6, gridCols + 1))} className="text-gray-300 hover:text-white hover:bg-white/10 w-6 h-6 rounded flex items-center justify-center transition" title="ভিডিও ছোট করুন">
                      <i className="fas fa-minus text-[10px]"></i>
                  </button>
                </div>
              )}
              
              <button onClick={() => setIsLocalModalOpen(true)} className="flex items-center gap-2 px-3 py-1.5 bg-emerald-600/20 hover:bg-emerald-600/40 text-emerald-400 rounded-full transition-colors border border-emerald-500/30">
                <i className="fas fa-folder-open text-sm"></i><span className="text-sm font-semibold hidden md:block">লোকাল ফাইল</span>
              </button>

              <button onClick={() => setIsCreateListModalOpen(true)} className="flex items-center gap-2 px-3 py-1.5 bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 rounded-full transition-colors border border-blue-500/30 hidden lg:flex">
                <i className="fas fa-folder-plus text-sm"></i><span className="text-sm font-semibold">প্লেলিস্ট বানান</span>
              </button>
              
              <button onClick={() => setIsAddModalOpen(true)} className="flex items-center gap-2 px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded-full transition-colors border border-white/20">
                <i className="fas fa-globe text-sm"></i><span className="text-sm font-semibold hidden md:block">অনলাইন ভিডিও</span>
              </button>
            </div>
          </header>

          <div className="flex flex-1 overflow-hidden">
            <aside className={`${isSidebarOpen ? 'w-64' : 'w-20'} flex-shrink-0 hidden md:flex flex-col bg-[#0f0f0f] transition-all duration-300 overflow-y-auto px-2 py-3 border-r border-white/10 custom-scrollbar`}>
              
              <div onClick={() => { setCurrentVideo(null); setIsMiniplayer(false); }} className={`flex items-center ${isSidebarOpen ? 'justify-start px-3' : 'justify-center flex-col'} py-2.5 my-1 rounded-xl cursor-pointer transition-colors ${!currentVideo ? 'bg-white/10 font-bold' : 'hover:bg-white/10'}`}>
                <div className={`flex items-center justify-center ${isSidebarOpen ? 'mr-4' : 'mb-1'} ${!currentVideo ? 'text-white' : 'text-gray-200'}`}><i className="fas fa-home text-xl"></i></div>
                <span className={`${isSidebarOpen ? 'text-sm' : 'text-[10px]'} ${!currentVideo ? 'text-white font-semibold' : 'text-gray-200'}`}>হোম</span>
              </div>
              
              <SidebarToggle icon={<i className="fas fa-video text-xl"></i>} label="সকল ভিডিও" isExpanded={isAllVideosExpanded} onToggle={() => setIsAllVideosExpanded(!isAllVideosExpanded)} isOpen={isSidebarOpen} scrollable={true}>
                  {videos.filter(v => v.type === 'video').length === 0 && <p className="text-xs text-gray-500 pl-1">কোনো ভিডিও নেই</p>}
                  {videos.filter(v => v.type === 'video').map((video, idx) => {
                      const watchedSec = progressData.times[video.id] || 0;
                      const totalSec = progressData.durations[video.id] || 0;
                      const progressPercent = totalSec > 0 ? Math.min((watchedSec / totalSec) * 100, 100) : 0;
                      return (
                        <div key={idx} className="flex gap-2 cursor-pointer hover:bg-white/10 p-1.5 rounded-lg transition-colors group" onClick={() => playVideo(video)}>
                          <div className="w-16 h-10 relative flex-shrink-0 bg-black rounded overflow-hidden border border-white/10">
                            <img src={video.thumbnail} className="w-full h-full object-cover" />
                            {progressPercent > 0 && (
                                <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-gray-600/80">
                                  <div className="h-full bg-red-600" style={{ width: `${progressPercent}%` }}></div>
                                </div>
                            )}
                          </div>
                          <div className="flex flex-col justify-center overflow-hidden flex-1">
                            <span className="text-[11px] font-semibold text-white line-clamp-1 group-hover:text-blue-400">{video.title}</span>
                            <span className="text-[9px] text-gray-400 truncate">{video.channel}</span>
                          </div>
                        </div>
                      )
                  })}
              </SidebarToggle>

              <SidebarToggle icon={<i className="fas fa-layer-group text-xl"></i>} label="সকল প্লেলিস্ট" isExpanded={isAllPlaylistsExpanded} onToggle={() => setIsAllPlaylistsExpanded(!isAllPlaylistsExpanded)} isOpen={isSidebarOpen} scrollable={true}>
                  {videos.filter(v => v.type.includes('playlist')).length === 0 && <p className="text-xs text-gray-500 pl-1">কোনো প্লেলিস্ট নেই</p>}
                  {videos.filter(v => v.type.includes('playlist')).map((video, idx) => {
                      return (
                        <div key={idx} className="flex gap-2 cursor-pointer hover:bg-white/10 p-1.5 rounded-lg transition-colors group" onClick={() => playVideo(video)}>
                          <div className="w-16 h-10 relative flex-shrink-0 bg-black rounded overflow-hidden border border-white/10">
                            <img src={video.thumbnail} className="w-full h-full object-cover" />
                            <div className="absolute bottom-0.5 right-0.5 bg-black/80 text-[8px] px-1 rounded flex items-center gap-0.5"><i className="fas fa-list"></i></div>
                          </div>
                          <div className="flex flex-col justify-center overflow-hidden flex-1">
                            <span className="text-[11px] font-semibold text-white line-clamp-1 group-hover:text-blue-400">{video.title}</span>
                            <span className="text-[9px] text-gray-400 truncate">{video.channel}</span>
                          </div>
                        </div>
                      )
                  })}
              </SidebarToggle>

              {currentVideoData?.type?.includes('playlist') && playlistQueue.length > 0 && (
                  <>
                  <hr className="border-white/10 my-2" />
                  <SidebarToggle icon={<i className="fas fa-play-circle text-xl text-blue-400"></i>} label="বর্তমান প্লেলিস্ট" isExpanded={isCurrentPlaylistExpanded} onToggle={() => setIsCurrentPlaylistExpanded(!isCurrentPlaylistExpanded)} isOpen={isSidebarOpen} scrollable={true}>
                      {playlistQueue.map((vidId, index) => {
                          const isPlaying = index === currentPlaylistIndex;
                          let title = `ভিডিও ${index + 1}`;
                          let channel = 'YouTube';
                          let thumbnail = `https://img.youtube.com/vi/${vidId}/mqdefault.jpg`;
                          
                          let progressPercent = 0;

                          if (currentVideoData.provider === 'local') {
                              const localVidInfo = currentVideoData.videoObjects?.[index];
                              if (localVidInfo) {
                                  title = localVidInfo.title;
                                  channel = localVidInfo.channel;
                                  thumbnail = localVidInfo.thumbnail;
                                  const watchedSec = progressData.times[localVidInfo.id] || 0;
                                  const totalSec = progressData.durations[localVidInfo.id] || 0;
                                  progressPercent = totalSec > 0 ? Math.min((watchedSec / totalSec) * 100, 100) : 0;
                              }
                          } else {
                              const localVidInfo = videos.find(v => v.videoId === vidId);
                              const meta = fetchedMeta[vidId];
                              if (localVidInfo) {
                                  title = localVidInfo.title;
                                  channel = localVidInfo.channel;
                                  const watchedSec = progressData.times[localVidInfo.id] || 0;
                                  const totalSec = progressData.durations[localVidInfo.id] || 0;
                                  progressPercent = totalSec > 0 ? Math.min((watchedSec / totalSec) * 100, 100) : 0;
                              } else if (meta && meta.title) {
                                  title = meta.title;
                                  channel = meta.channel;
                              } else if (meta && meta.loading) {
                                  title = 'লোড হচ্ছে...';
                              }
                          }

                          return (
                              <div 
                                  key={index} 
                                  onClick={() => {
                                      if (currentVideoData.provider === 'local') {
                                          setCurrentPlaylistIndex(index);
                                          // Update Play Index
                                          const indexes = JSON.parse(localStorage.getItem('ytClonePlaylistIndexes') || '{}');
                                          indexes[currentVideoData.id] = index;
                                          localStorage.setItem('ytClonePlaylistIndexes', JSON.stringify(indexes));
                                      } else {
                                          playerRef.current?.playVideoAt(index);
                                      }
                                  }}
                                  className={`flex gap-2 cursor-pointer hover:bg-white/10 p-1.5 rounded-lg transition-colors group ${isPlaying ? 'bg-white/20 border border-white/10' : ''}`}
                              >
                                  <div className="text-[10px] text-gray-400 w-3 flex items-center justify-center">
                                      {isPlaying ? <i className="fas fa-play text-white"></i> : index + 1}
                                  </div>
                                  <div className="w-16 h-10 relative flex-shrink-0 bg-black rounded overflow-hidden border border-white/10">
                                      <img src={thumbnail} className="w-full h-full object-cover" />
                                      {progressPercent > 0 && (
                                          <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-gray-600/80">
                                              <div className="h-full bg-red-600" style={{ width: `${progressPercent}%` }}></div>
                                          </div>
                                      )}
                                  </div>
                                  <div className="flex flex-col justify-center overflow-hidden flex-1">
                                      <span className={`text-[11px] font-semibold line-clamp-1 group-hover:text-blue-400 ${isPlaying ? 'text-white' : 'text-gray-300'}`}>{title}</span>
                                      <span className="text-[9px] text-gray-400 truncate">{channel}</span>
                                  </div>
                              </div>
                          )
                      })}
                  </SidebarToggle>
                  </>
              )}

              {isSidebarOpen && <hr className="border-white/10 my-2" />}
              
              <SidebarToggle icon={<i className="fas fa-history text-xl"></i>} label="ইতিহাস" isExpanded={isHistoryExpanded} onToggle={() => setIsHistoryExpanded(!isHistoryExpanded)} isOpen={isSidebarOpen} scrollable={true}>
                  {watchHistory.length === 0 ? (
                    <p className="text-xs text-gray-500 pl-1">কোনো ইতিহাস নেই</p>
                  ) : (
                    watchHistory.map((video, idx) => {
                      const watchedSec = progressData.times[video.id] || 0;
                      const totalSec = progressData.durations[video.id] || 0;
                      const progressPercent = totalSec > 0 ? Math.min((watchedSec / totalSec) * 100, 100) : 0;
                      return (
                        <div key={idx} className="flex gap-2 cursor-pointer hover:bg-white/10 p-1.5 rounded-lg transition-colors group" onClick={() => playVideo(video)}>
                          <div className="w-16 h-10 relative flex-shrink-0 bg-black rounded overflow-hidden border border-white/10">
                            <img src={video.thumbnail} className="w-full h-full object-cover" />
                            {progressPercent > 0 && (
                                <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-gray-600/80">
                                  <div className="h-full bg-red-600" style={{ width: `${progressPercent}%` }}></div>
                                </div>
                            )}
                          </div>
                          <div className="flex flex-col justify-center overflow-hidden flex-1">
                            <span className="text-[11px] font-semibold text-white line-clamp-1 group-hover:text-blue-400">{video.title}</span>
                            <span className="text-[9px] text-gray-400 truncate">{video.channel}</span>
                          </div>
                        </div>
                      )
                    })
                  )}
              </SidebarToggle>

            </aside>

            <main className="flex-1 overflow-y-auto bg-[#0f0f0f] relative custom-scrollbar">
              
              <div className={`${isTheaterMode && !isMiniplayer ? 'w-full max-w-full h-[calc(100vh-64px)] p-4 flex-col' : 'max-w-[1600px] mx-auto p-4 flex-col lg:flex-row'} gap-6 ${(currentVideo && !isMiniplayer) ? 'flex' : 'absolute w-0 h-0 overflow-hidden invisible'}`}>
                <div className={`flex flex-col relative ${isTheaterMode && !isMiniplayer ? 'w-full h-full' : 'flex-1 lg:w-2/3'}`}>
                  {currentVideo && (
                    <div 
                      className={`${isMiniplayer ? 'fixed z-[100] flex flex-col overflow-visible visible' : (isTheaterMode ? 'w-full h-full relative' : 'w-full aspect-video relative')}`}
                      style={isMiniplayer && playerRect ? { left: `${playerRect.left}px`, top: `${playerRect.top}px`, width: `${playerRect.width}px`, height: `${playerRect.height}px` } : {}}
                    >
                      <div className={`w-full h-full flex flex-col relative rounded-xl overflow-hidden group ${isMiniplayer ? 'bg-[#212121] shadow-2xl border border-gray-700' : 'bg-black shadow-lg'}`}>
                        <div className={`${isMiniplayer ? 'flex' : 'hidden'} h-10 flex-shrink-0 justify-between items-center px-3 bg-[#181818] cursor-move select-none z-10 border-b border-gray-700`} onMouseDown={handleDragStart} onTouchStart={handleDragStart}>
                          <div className="flex flex-col truncate pr-2 w-[75%]">
                            <span className="text-sm font-bold truncate text-white">
                                {currentVideoData?.provider === 'gdrive' && <i className="fab fa-google-drive mr-2 text-blue-400"></i>}
                                {currentVideoData?.provider === 'local' && <i className="fas fa-hdd mr-2 text-emerald-400"></i>}
                                {currentVideoData?.type?.includes('playlist') && <i className="fas fa-play mr-2 text-gray-400 text-[10px]"></i>}
                                {displayTitle}
                            </span>
                          </div>
                          <div className="flex gap-4 text-gray-400 items-center">
                            <button onClick={() => setIsMiniplayer(false)} className="hover:text-white" title="Expand"><i className="fas fa-expand-alt"></i></button>
                            <button onClick={() => { setCurrentVideo(null); setIsMiniplayer(false); }} className="hover:text-white" title="Close"><i className="fas fa-times text-lg"></i></button>
                          </div>
                        </div>

                        <div className="w-full flex-1 relative bg-black pointer-events-auto overflow-hidden">
                          {(isDragging || resizeState.active) && <div className="absolute inset-0 z-10 bg-transparent"></div>}
                          
                          <div 
                              ref={ytContainerRef} 
                              className={`w-full h-full absolute inset-0 ${(!currentVideoData?.provider || currentVideoData?.provider === 'youtube') ? 'block' : 'hidden'}`}
                          ></div>

                          {currentVideoData?.provider === 'gdrive' && (
                              <iframe 
                                  src={`https://drive.google.com/file/d/${currentVideoData.driveId}/preview`} 
                                  className="w-full h-full border-0 absolute inset-0 z-0" 
                                  allow="autoplay; fullscreen"
                                  allowFullScreen
                              ></iframe>
                          )}

                          {currentVideoData?.provider === 'local' && (
                              <video 
                                  ref={localVideoRef}
                                  src={currentVideoData.type === 'local_playlist' ? currentVideoData.videoObjects[currentPlaylistIndex]?.blobUrl : currentVideoData.blobUrl} 
                                  className="w-full h-full object-contain absolute inset-0 z-0 outline-none" 
                                  controls
                                  autoPlay
                                  onLoadedMetadata={(e) => {
                                      const vidId = currentVideoData.type === 'local_playlist' ? currentVideoData.videoObjects[currentPlaylistIndex].id : currentVideoData.id;
                                      const times = JSON.parse(localStorage.getItem('ytCloneTimes') || '{}');
                                      if (times[vidId] && times[vidId] > 0) {
                                          e.target.currentTime = times[vidId];
                                      }
                                  }}
                                  onEnded={() => {
                                      if (currentVideoData.type === 'local_playlist' && currentPlaylistIndex < currentVideoData.videoObjects.length - 1) {
                                          const nextIdx = currentPlaylistIndex + 1;
                                          setCurrentPlaylistIndex(nextIdx);
                                          
                                          const indexes = JSON.parse(localStorage.getItem('ytClonePlaylistIndexes') || '{}');
                                          indexes[currentVideoData.id] = nextIdx;
                                          localStorage.setItem('ytClonePlaylistIndexes', JSON.stringify(indexes));
                                      }
                                  }}
                                  onTimeUpdate={(e) => {
                                      const time = Math.floor(e.target.currentTime);
                                      const duration = Math.floor(e.target.duration);
                                      const vidId = currentVideoData.type === 'local_playlist' ? currentVideoData.videoObjects[currentPlaylistIndex].id : currentVideoData.id;
                                      
                                      setProgressData(prev => ({
                                          times: { ...prev.times, [vidId]: time },
                                          durations: { ...prev.durations, [vidId]: duration }
                                      }));

                                      // Save strictly to local storage
                                      const storedTimes = JSON.parse(localStorage.getItem('ytCloneTimes') || '{}');
                                      const storedDurations = JSON.parse(localStorage.getItem('ytCloneDurations') || '{}');
                                      storedTimes[vidId] = time;
                                      storedDurations[vidId] = duration;
                                      localStorage.setItem('ytCloneTimes', JSON.stringify(storedTimes));
                                      localStorage.setItem('ytCloneDurations', JSON.stringify(storedDurations));
                                  }}
                              ></video>
                          )}
                        </div>

                        {isTheaterMode && !isMiniplayer && (
                            <button onClick={() => setIsTheaterMode(false)} className="absolute bottom-[70px] right-6 z-50 bg-black/80 hover:bg-black text-white px-5 py-2.5 rounded-md flex items-center gap-2 transition-all backdrop-blur-sm border border-white/20 opacity-0 group-hover:opacity-100 shadow-xl font-medium text-sm">
                                <i className="fas fa-compress"></i> সাধারণ ভিউ
                            </button>
                        )}
                      </div>

                      {isMiniplayer && (
                        <>
                          <div className="absolute -top-2 left-2 right-2 h-4 cursor-n-resize z-20" onMouseDown={(e) => handleResizeStart(e, 'n')} onTouchStart={(e) => handleResizeStart(e, 'n')} />
                          <div className="absolute -bottom-2 left-2 right-2 h-4 cursor-s-resize z-20" onMouseDown={(e) => handleResizeStart(e, 's')} onTouchStart={(e) => handleResizeStart(e, 's')} />
                          <div className="absolute top-2 bottom-2 -left-2 w-4 cursor-w-resize z-20" onMouseDown={(e) => handleResizeStart(e, 'w')} onTouchStart={(e) => handleResizeStart(e, 'w')} />
                          <div className="absolute top-2 bottom-2 -right-2 w-4 cursor-e-resize z-20" onMouseDown={(e) => handleResizeStart(e, 'e')} onTouchStart={(e) => handleResizeStart(e, 'e')} />
                          <div className="absolute -top-2 -left-2 w-6 h-6 cursor-nw-resize z-30" onMouseDown={(e) => handleResizeStart(e, 'nw')} onTouchStart={(e) => handleResizeStart(e, 'nw')} />
                          <div className="absolute -top-2 -right-2 w-6 h-6 cursor-ne-resize z-30" onMouseDown={(e) => handleResizeStart(e, 'ne')} onTouchStart={(e) => handleResizeStart(e, 'ne')} />
                          <div className="absolute -bottom-2 -left-2 w-6 h-6 cursor-sw-resize z-30" onMouseDown={(e) => handleResizeStart(e, 'sw')} onTouchStart={(e) => handleResizeStart(e, 'sw')} />
                          <div className="absolute -bottom-2 -right-2 w-6 h-6 cursor-se-resize z-30" onMouseDown={(e) => handleResizeStart(e, 'se')} onTouchStart={(e) => handleResizeStart(e, 'se')} />
                        </>
                      )}
                    </div>
                  )}

                  <div className={`${(isMiniplayer || isTheaterMode) ? 'hidden' : 'block'}`}>
                    <h1 className="text-xl md:text-2xl font-bold mt-4 mb-1">
                        {currentVideoData?.provider === 'gdrive' && <span className="bg-blue-600/20 text-blue-400 text-xs px-2 py-1 rounded mr-2 align-middle border border-blue-500/30"><i className="fab fa-google-drive"></i> Google Drive</span>}
                        {currentVideoData?.provider === 'local' && <span className="bg-emerald-600/20 text-emerald-400 text-xs px-2 py-1 rounded mr-2 align-middle border border-emerald-500/30"><i className="fas fa-hdd"></i> Local File</span>}
                        {displayTitle}
                    </h1>
                    {currentVideoData?.type?.includes('playlist') && (
                        <p className="text-sm text-gray-400 mb-3 flex items-center gap-2">
                            <i className="fas fa-list"></i> {currentVideoData.title}
                        </p>
                    )}
                    <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                      <div className="flex items-center gap-3">
                        <img src={displayAvatar || 'https://ui-avatars.com/api/?name=User&background=random'} alt={displayChannel} className="w-10 h-10 rounded-full" />
                        <div>
                          <h3 className="font-bold text-sm">{displayChannel}</h3>
                          <p className="text-xs text-gray-400">সাবস্ক্রাইবার অজানা</p>
                        </div>
                        <button className="bg-white text-black px-4 py-2 rounded-full font-bold ml-2 hover:bg-gray-200 transition">সাবস্ক্রাইব</button>
                      </div>
                      <div className="flex items-center gap-2">
                        <button onClick={() => setIsTheaterMode(true)} className="flex items-center gap-2 px-4 py-2 bg-white/10 rounded-full hover:bg-white/20 transition font-bold whitespace-nowrap" title="থিয়েটার মোড">
                          <i className="fas fa-tv"></i> থিয়েটার
                        </button>
                        <button onClick={activateMiniplayer} className="flex items-center gap-2 px-4 py-2 bg-white/10 rounded-full hover:bg-white/20 transition font-bold whitespace-nowrap" title="Miniplayer">
                          <i className="fas fa-compress-alt"></i> মিনিপ্লেয়ার
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div className={`lg:w-1/3 w-full flex flex-col gap-3 ${(isMiniplayer || isTheaterMode) ? 'hidden' : 'flex'}`}>
                  
                  {playlistQueue.length > 0 && currentVideoData?.type.includes('playlist') && (
                      <div className="bg-[#212121] rounded-xl border border-white/10 flex flex-col max-h-[500px] shadow-lg mb-2">
                          <div className="p-4 border-b border-white/10 bg-[#181818] rounded-t-xl">
                              <h3 className="font-bold text-lg leading-tight">{currentVideoData.title}</h3>
                              <p className="text-xs text-gray-400 mt-1">{currentVideoData.channel} • {currentPlaylistIndex + 1} / {playlistQueue.length}</p>
                          </div>
                          <div className="overflow-y-auto flex-1 p-2 flex flex-col gap-1 custom-scrollbar">
                              {playlistQueue.map((vidId, index) => {
                                  const isPlaying = index === currentPlaylistIndex;
                                  let title = `ভিডিও ${index + 1}`;
                                  let channel = 'YouTube';
                                  let thumbnail = `https://img.youtube.com/vi/${vidId}/mqdefault.jpg`;

                                  if (currentVideoData.provider === 'local') {
                                      const localVidInfo = currentVideoData.videoObjects?.[index];
                                      if (localVidInfo) {
                                          title = localVidInfo.title;
                                          channel = localVidInfo.channel;
                                          thumbnail = localVidInfo.thumbnail;
                                      }
                                  } else {
                                      const localVidInfo = videos.find(v => v.videoId === vidId);
                                      const meta = fetchedMeta[vidId];
                                      if (localVidInfo) {
                                          title = localVidInfo.title;
                                          channel = localVidInfo.channel;
                                      } else if (meta && meta.title) {
                                          title = meta.title;
                                          channel = meta.channel;
                                      } else if (meta && meta.loading) {
                                          title = 'লোড হচ্ছে...';
                                      }
                                  }

                                  return (
                                      <div 
                                        key={index} 
                                        onClick={() => {
                                            if (currentVideoData.provider === 'local') {
                                                setCurrentPlaylistIndex(index);
                                                const indexes = JSON.parse(localStorage.getItem('ytClonePlaylistIndexes') || '{}');
                                                indexes[currentVideoData.id] = index;
                                                localStorage.setItem('ytClonePlaylistIndexes', JSON.stringify(indexes));
                                            } else {
                                                playerRef.current?.playVideoAt(index);
                                            }
                                        }}
                                        className={`flex gap-3 p-2 rounded-lg cursor-pointer transition items-center ${isPlaying ? 'bg-white/20' : 'hover:bg-white/10'}`}
                                      >
                                          <div className="text-xs text-gray-400 w-4 text-center">
                                              {isPlaying ? <i className="fas fa-play text-white text-[10px]"></i> : index + 1}
                                          </div>
                                          <div className="w-24 h-14 flex-shrink-0 relative rounded overflow-hidden bg-black border border-white/10">
                                              <img src={thumbnail} className="w-full h-full object-cover" />
                                          </div>
                                          <div className="flex flex-col justify-center overflow-hidden pr-2">
                                              <h4 className={`text-sm font-semibold line-clamp-2 leading-snug ${isPlaying ? 'text-white' : 'text-gray-300'}`}>{title}</h4>
                                              <p className="text-xs text-gray-400 mt-0.5 truncate">{channel}</p>
                                          </div>
                                      </div>
                                  )
                              })}
                          </div>
                      </div>
                  )}

                  <h3 className="font-bold text-lg mb-2 mt-2">আপনার জন্য প্রস্তাবিত</h3>
                  {videos.filter(v => v?.id !== currentVideo?.id).map(video => {
                      const watchedSec = progressData.times[video.id] || 0;
                      const totalSec = progressData.durations[video.id] || 0;
                      const progressPercent = totalSec > 0 ? Math.min((watchedSec / totalSec) * 100, 100) : 0;

                      return (
                        <div key={video.id} className="flex gap-2 cursor-pointer group relative">
                          <div 
                            className="w-40 h-24 flex-shrink-0 relative rounded-lg overflow-hidden bg-gray-900 border border-white/10"
                            onMouseEnter={() => handleMouseEnter(video)}
                            onMouseLeave={handleMouseLeave}
                          >
                            <button 
                              onClick={(e) => deleteMedia(e, video.id)}
                              className="absolute top-1 left-1 bg-black/80 hover:bg-red-600 text-white w-6 h-6 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition z-30 shadow-lg"
                              title="মুছে ফেলুন"
                            >
                              <i className="fas fa-trash text-[10px]"></i>
                            </button>

                            <img src={video.thumbnail} alt={video.title} onClick={() => playVideo(video)} className={`w-full h-full object-cover transition duration-300 cursor-pointer ${hoveredVideo === video.id ? 'opacity-0' : 'opacity-100'}`} />
                            
                            {hoveredVideo === video.id && <HoverPlayer video={video} savedTime={watchedSec} onPlay={() => playVideo(video)} />}

                            {progressPercent > 0 && hoveredVideo !== video.id && (
                                <div className="absolute bottom-0 left-0 right-0 h-1 bg-gray-600/80 z-20 pointer-events-none">
                                    <div className="h-full bg-red-600" style={{ width: `${progressPercent}%` }}></div>
                                </div>
                            )}

                            {video.type.includes('playlist') && (
                                <div className="absolute bottom-1 right-1 bg-black/80 text-xs px-1.5 py-0.5 rounded flex items-center gap-1 z-20 pointer-events-none">
                                    <i className="fas fa-list text-[10px]"></i> Playlist
                                </div>
                            )}
                          </div>
                          <div className="flex flex-col pr-6" onClick={() => playVideo(video)}>
                            <h4 className="text-sm font-semibold line-clamp-2 group-hover:text-blue-400">{video.title}</h4>
                            <p className="text-xs text-gray-400 mt-1">{video.channel}</p>
                          </div>
                        </div>
                      )
                  })}
                </div>
              </div>

              <div className={`p-4 sm:p-6 lg:p-8 max-w-[1800px] mx-auto ${(!currentVideo || isMiniplayer) ? 'block' : 'hidden'}`}>
                
                <div className="mb-6">
                  {searchQuery && <h2 className="text-xl font-bold">"{searchQuery}" এর ফলাফল</h2>}
                </div>

                <div className={gridClass}>
                  {filteredVideos.map((video, index) => {
                      const watchedSec = progressData.times[video.id] || 0;
                      const totalSec = progressData.durations[video.id] || 0;
                      const progressPercent = totalSec > 0 ? Math.min((watchedSec / totalSec) * 100, 100) : 0;

                      return (
                        <div key={`${video.id}-${index}`} className="flex flex-col group relative">
                          <button 
                            onClick={(e) => deleteMedia(e, video.id)}
                            className="absolute top-2 left-2 bg-black/80 hover:bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition z-30 shadow-lg"
                            title="মুছে ফেলুন"
                          >
                            <i className="fas fa-trash text-sm"></i>
                          </button>

                          <div 
                            className="w-full aspect-video relative rounded-xl overflow-hidden mb-3 border border-white/10 bg-gray-900 cursor-pointer"
                            onMouseEnter={() => handleMouseEnter(video)}
                            onMouseLeave={handleMouseLeave}
                          >
                            <img src={video.thumbnail} alt={video.title} onClick={() => playVideo(video)} className={`w-full h-full object-cover transition duration-300 ${hoveredVideo === video.id ? 'opacity-0' : 'opacity-100'}`} />
                            
                            {hoveredVideo === video.id && <HoverPlayer video={video} savedTime={watchedSec} onPlay={() => playVideo(video)} />}

                            {progressPercent > 0 && hoveredVideo !== video.id && (
                                <div className="absolute bottom-0 left-0 right-0 h-1 bg-gray-600/80 z-20 pointer-events-none">
                                    <div className="h-full bg-red-600" style={{ width: `${progressPercent}%` }}></div>
                                </div>
                            )}

                            {video.type.includes('playlist') && (
                                <div className="absolute bottom-1.5 right-1.5 bg-black/80 text-xs px-2 py-0.5 rounded font-medium flex items-center gap-1 z-20 pointer-events-none">
                                    <i className="fas fa-list"></i> Playlist
                                </div>
                            )}
                          </div>
                          
                          <div className="flex gap-3 pr-2 cursor-pointer" onClick={() => playVideo(video)}>
                            <img src={video.channelAvatar} alt={video.channel} className="w-9 h-9 rounded-full mt-1 flex-shrink-0" />
                            <div>
                              <h3 className="text-sm font-semibold line-clamp-2 group-hover:text-blue-400">{video.title}</h3>
                              <p className="text-sm text-gray-400 mt-1 hover:text-white transition">{video.channel}</p>
                              <p className="text-sm text-gray-400">{video.views}</p>
                            </div>
                          </div>
                        </div>
                      )
                  })}
                </div>
              </div>
            </main>
          </div>

          {/* Local Modal (File & Folder Upload) */}
          {isLocalModalOpen && (
            <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/80 p-4 backdrop-blur-sm">
                <div className="bg-[#212121] rounded-2xl w-full max-w-lg border border-gray-700 shadow-2xl overflow-hidden">
                    <div className="flex justify-between items-center p-4 border-b border-gray-700">
                        <h2 className="text-xl font-bold">লোকাল ফাইল বা ফোল্ডার যোগ করুন</h2>
                        <button onClick={() => setIsLocalModalOpen(false)} className="text-gray-400 hover:text-white"><i className="fas fa-times text-xl"></i></button>
                    </div>
                    <div className="p-6 flex flex-col gap-6">
                        <div className="bg-[#121212] p-5 rounded-xl border border-gray-600 flex flex-col items-center justify-center gap-3 hover:bg-white/5 transition relative cursor-pointer">
                            <i className="fas fa-video text-3xl text-emerald-400"></i>
                            <div className="text-center">
                                <h3 className="font-bold mb-1">ভিডিও ফাইল নির্বাচন করুন</h3>
                                <p className="text-xs text-gray-400">এক বা একাধিক .mp4, .webm ফাইল</p>
                            </div>
                            <input 
                                type="file" 
                                accept="video/*" 
                                multiple 
                                className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                onChange={(e) => handleLocalFiles(e, false)}
                            />
                        </div>
                        
                        <div className="bg-[#121212] p-5 rounded-xl border border-gray-600 flex flex-col items-center justify-center gap-3 hover:bg-white/5 transition relative cursor-pointer">
                            <i className="fas fa-folder-open text-3xl text-blue-400"></i>
                            <div className="text-center">
                                <h3 className="font-bold mb-1">পুরো ফোল্ডার নির্বাচন করুন</h3>
                                <p className="text-xs text-gray-400">ফোল্ডারের ভিডিওগুলো প্লেলিস্ট হবে</p>
                            </div>
                            <input 
                                type="file" 
                                accept="video/*" 
                                webkitdirectory="true" 
                                directory="true" 
                                multiple 
                                className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                onChange={(e) => handleLocalFiles(e, true)}
                            />
                        </div>
                        
                        <p className="text-[11px] text-gray-400 text-center">
                            <i className="fas fa-info-circle mr-1 text-yellow-500"></i> 
                            ব্রাউজারের সিকিউরিটি রুল অনুযায়ী পেজ রিলোড দিলে লোকাল ফাইলগুলো মুছে যাবে।
                        </p>
                    </div>
                </div>
            </div>
          )}

          {/* Other Modals (Online Add, Alert, Confirm, Create Playlist) ... */}
          {alertState.isOpen && (
            <div className="fixed inset-0 z-[300] flex items-center justify-center bg-black/80 p-4 backdrop-blur-sm transition-opacity">
                <div className="bg-[#212121] rounded-2xl w-full max-w-sm border border-gray-700 shadow-2xl p-6 text-center transform transition-all scale-100">
                    <div className="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-500/20">
                        <i className="fas fa-exclamation-triangle text-2xl text-red-500"></i>
                    </div>
                    <h2 className="text-xl font-bold mb-2">অ্যালার্ট</h2>
                    <p className="text-gray-400 mb-6">{alertState.message}</p>
                    <button onClick={() => setAlertState({isOpen: false, message: ''})} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2.5 rounded-full font-bold transition w-full">
                        ঠিক আছে
                    </button>
                </div>
            </div>
          )}

          {confirmState.isOpen && (
            <div className="fixed inset-0 z-[300] flex items-center justify-center bg-black/80 p-4 backdrop-blur-sm transition-opacity">
                <div className="bg-[#212121] rounded-2xl w-full max-w-sm border border-gray-700 shadow-2xl p-6 text-center transform transition-all scale-100">
                    <div className="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-500/20">
                        <i className="fas fa-trash-alt text-2xl text-red-500"></i>
                    </div>
                    <h2 className="text-xl font-bold mb-2">নিশ্চিত করুন</h2>
                    <p className="text-gray-400 mb-6">{confirmState.message}</p>
                    <div className="flex gap-3">
                        <button onClick={() => setConfirmState({isOpen: false, message: '', targetId: null})} className="flex-1 bg-white/10 hover:bg-white/20 text-white py-2.5 rounded-full font-bold transition">
                            বাতিল
                        </button>
                        <button onClick={executeDelete} className="flex-1 bg-red-600 hover:bg-red-500 text-white py-2.5 rounded-full font-bold transition">
                            ডিলিট করুন
                        </button>
                    </div>
                </div>
            </div>
          )}

          {isAddModalOpen && (
            <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/80 p-4 backdrop-blur-sm">
                <div className="bg-[#212121] rounded-2xl w-full max-w-lg border border-gray-700 shadow-2xl">
                    <div className="flex justify-between items-center p-4 border-b border-gray-700">
                        <h2 className="text-xl font-bold">অনলাইন ভিডিও যোগ করুন</h2>
                        <button onClick={() => setIsAddModalOpen(false)} className="text-gray-400 hover:text-white"><i className="fas fa-times text-xl"></i></button>
                    </div>
                    <form onSubmit={handleAddSubmit} className="p-4 flex flex-col gap-4">
                        <div>
                            <label className="block text-sm text-gray-400 mb-1">ইউটিউব বা গুগল ড্রাইভ লিংক/এমবেড কোড</label>
                            <input type="text" required placeholder='যেমন: https://youtube.com/...' className="w-full bg-[#121212] border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500" value={newMediaInput.link} onChange={(e) => setNewMediaInput({...newMediaInput, link: e.target.value})} />
                        </div>
                        <div>
                            <label className="block text-sm text-gray-400 mb-1">টাইটেল (খালি রাখলে নিজে থেকেই তৈরি হবে)</label>
                            <input type="text" placeholder="ভিডিও বা প্লেলিস্টের নাম" className="w-full bg-[#121212] border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500" value={newMediaInput.title} onChange={(e) => setNewMediaInput({...newMediaInput, title: e.target.value})} />
                        </div>
                        <div>
                            <label className="block text-sm text-gray-400 mb-1">চ্যানেলের নাম (ঐচ্ছিক)</label>
                            <input type="text" placeholder="চ্যানেলের নাম" className="w-full bg-[#121212] border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500" value={newMediaInput.channel} onChange={(e) => setNewMediaInput({...newMediaInput, channel: e.target.value})} />
                        </div>
                        <div className="flex justify-end gap-3 mt-4">
                            <button type="button" onClick={() => setIsAddModalOpen(false)} className="px-4 py-2 rounded-full font-bold hover:bg-white/10">বাতিল</button>
                            <button type="submit" className="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-full font-bold transition">যোগ করুন</button>
                        </div>
                    </form>
                </div>
            </div>
          )}

          {isCreateListModalOpen && (
            <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/80 p-4 backdrop-blur-sm">
                <div className="bg-[#212121] rounded-2xl w-full max-w-lg border border-gray-700 shadow-2xl">
                    <div className="flex justify-between items-center p-4 border-b border-gray-700">
                        <h2 className="text-xl font-bold">নতুন কাস্টম প্লেলিস্ট বানান</h2>
                        <button onClick={() => setIsCreateListModalOpen(false)} className="text-gray-400 hover:text-white"><i className="fas fa-times text-xl"></i></button>
                    </div>
                    <form onSubmit={handleCreatePlaylist} className="p-4 flex flex-col gap-4">
                        <div>
                            <label className="block text-sm text-gray-400 mb-1">প্লেলিস্টের নাম</label>
                            <input type="text" required placeholder="যেমন: My Favorite Videos" className="w-full bg-[#121212] border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500" value={newListTitle} onChange={(e) => setNewListTitle(e.target.value)} />
                        </div>
                        <div>
                            <label className="block text-sm text-gray-400 mb-1">ভিডিও সিলেক্ট করুন</label>
                            <div className="max-h-60 overflow-y-auto bg-[#121212] rounded-lg p-2 flex flex-col gap-1 border border-gray-600 custom-scrollbar">
                                {videos.filter(v => v.type === 'video' && v.provider !== 'gdrive' && v.provider !== 'local').length === 0 && <p className="text-center text-gray-400 py-4 text-sm">কোনো ইউটিউব ভিডিও নেই। আগে ভিডিও যোগ করুন!</p>}
                                {videos.filter(v => v.type === 'video' && v.provider !== 'gdrive' && v.provider !== 'local').map(v => (
                                    <label key={v.id} className="flex items-center gap-3 p-2 hover:bg-white/10 rounded cursor-pointer transition">
                                        <input type="checkbox" checked={selectedVideoIds.includes(v.videoId)} onChange={(e) => { if(e.target.checked) setSelectedVideoIds([...selectedVideoIds, v.videoId]); else setSelectedVideoIds(selectedVideoIds.filter(id => id !== v.videoId)); }} className="w-4 h-4 rounded border-gray-500 bg-black cursor-pointer" />
                                        <img src={v.thumbnail} className="w-12 h-8 object-cover rounded" />
                                        <span className="text-sm truncate select-none">{v.title}</span>
                                    </label>
                                ))}
                            </div>
                            <p className="text-xs text-gray-400 mt-2 text-right">{selectedVideoIds.length} টি ভিডিও সিলেক্ট করা হয়েছে</p>
                        </div>
                        <div className="flex justify-end gap-3 mt-2">
                            <button type="button" onClick={() => setIsCreateListModalOpen(false)} className="px-4 py-2 rounded-full font-bold hover:bg-white/10">বাতিল</button>
                            <button type="submit" className="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-full font-bold transition">সেভ করুন</button>
                        </div>
                    </form>
                </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
