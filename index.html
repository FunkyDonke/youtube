<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTube Clone</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- FontAwesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- React & ReactDOM CDN -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  
  <!-- Babel for JSX compilation in browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- YouTube Iframe API -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    window.ytApiLoaded = false;
    function onYouTubeIframeAPIReady() {
      window.ytApiLoaded = true;
      window.dispatchEvent(new Event('yt-api-ready'));
    }
  </script>
  <style>
    /* Custom Scrollbar for Playlist Queue */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #555; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #888; }
  </style>
</head>
<body class="bg-[#0f0f0f] text-white font-sans">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const initialVideos = [
      {
        id: 'aqz-KE-bpKQ', videoId: 'aqz-KE-bpKQ', listId: null, type: 'video',
        title: 'Big Buck Bunny 60fps 4K - Official Blender Foundation Short Film', channel: 'Blender', views: '12M views',
        thumbnail: 'https://img.youtube.com/vi/aqz-KE-bpKQ/hqdefault.jpg', channelAvatar: 'https://ui-avatars.com/api/?name=Blender&background=random',
      },
      {
        id: 'LXb3EKWsInQ', videoId: 'LXb3EKWsInQ', listId: null, type: 'video',
        title: 'COSTA RICA IN 4K 60fps HDR (ULTRA HD)', channel: 'Jacob + Katie Schwarz', views: '150M views',
        thumbnail: 'https://img.youtube.com/vi/LXb3EKWsInQ/hqdefault.jpg', channelAvatar: 'https://ui-avatars.com/api/?name=Jacob&background=random',
      },
      {
        id: 'w7ejDZ8SWv8', videoId: 'w7ejDZ8SWv8', listId: null, type: 'video',
        title: 'React JS Crash Course for Beginners', channel: 'Code Step By Step', views: '2.5M views',
        thumbnail: 'https://img.youtube.com/vi/w7ejDZ8SWv8/hqdefault.jpg', channelAvatar: 'https://ui-avatars.com/api/?name=Code&background=random',
      }
    ];

    function parseYouTubeInput(input) {
      let videoId = null;
      let listId = null;
      let title = '';
      let urlStr = input.replace(/&amp;/g, '&');

      const iframeMatch = urlStr.match(/src=["'](.*?)["']/);
      if (iframeMatch) urlStr = iframeMatch[1];
      const titleMatch = input.match(/title=["'](.*?)["']/);
      if (titleMatch) title = titleMatch[1];
      
      if(title.toLowerCase() === 'youtube video player' || title.toLowerCase() === 'custom video') title = ''; 

      try {
        if (!urlStr.startsWith('http') && !urlStr.startsWith('//')) urlStr = 'https://' + urlStr;
        else if (urlStr.startsWith('//')) urlStr = 'https:' + urlStr;
        
        const url = new URL(urlStr);
        if (url.searchParams.has('v')) videoId = url.searchParams.get('v');
        if (url.searchParams.has('list')) listId = url.searchParams.get('list');
        
        if (url.pathname.startsWith('/embed/')) {
          const pathParts = url.pathname.split('/');
          const id = pathParts[pathParts.length - 1];
          if (id && id !== 'videoseries') videoId = id;
        } else if (url.hostname.includes('youtu.be')) {
          videoId = url.pathname.slice(1);
        }
      } catch (e) {
        console.error("URL Error", e);
      }
      return { videoId, listId, title };
    }

    function App() {
      const [videos, setVideos] = useState(() => {
        const saved = localStorage.getItem('ytCloneVideos');
        return saved ? JSON.parse(saved) : initialVideos;
      });

      const [currentVideo, setCurrentVideo] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [isSidebarOpen, setIsSidebarOpen] = useState(true);
      const [activeTab, setActiveTab] = useState('home');
      const [watchHistory, setWatchHistory] = useState([]);
      const [lastWatched, setLastWatched] = useState(null);

      // Playlist Sidebar States
      const [playlistQueue, setPlaylistQueue] = useState([]);
      const [currentPlaylistIndex, setCurrentPlaylistIndex] = useState(0);

      // Custom Alert & Confirm States
      const [alertState, setAlertState] = useState({ isOpen: false, message: '' });
      const [confirmState, setConfirmState] = useState({ isOpen: false, message: '', targetId: null });

      const [isAddModalOpen, setIsAddModalOpen] = useState(false);
      const [newMediaInput, setNewMediaInput] = useState({ link: '', title: '', channel: '' });
      const [isCreateListModalOpen, setIsCreateListModalOpen] = useState(false);
      const [newListTitle, setNewListTitle] = useState('');
      const [selectedVideoIds, setSelectedVideoIds] = useState([]);

      const [isMiniplayer, setIsMiniplayer] = useState(false);
      const [playerRect, setPlayerRect] = useState(null); 
      const [isDragging, setIsDragging] = useState(false);
      const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
      const [resizeState, setResizeState] = useState({ active: false, dir: null, startX: 0, startY: 0, startLeft: 0, startTop: 0, startWidth: 0, startHeight: 0 });

      const [ytReady, setYtReady] = useState(window.ytApiLoaded);
      const playerRef = useRef(null);
      const timeIntervalRef = useRef(null);

      const currentVideoData = currentVideo ? (videos.find(v => v.id === currentVideo.id) || currentVideo) : null;

      useEffect(() => {
        const savedHistory = localStorage.getItem('ytCloneHistory');
        const savedLastWatched = localStorage.getItem('ytCloneLastWatched');
        if (savedHistory) setWatchHistory(JSON.parse(savedHistory));
        if (savedLastWatched) setLastWatched(JSON.parse(savedLastWatched));

        const handleReady = () => setYtReady(true);
        window.addEventListener('yt-api-ready', handleReady);
        return () => window.removeEventListener('yt-api-ready', handleReady);
      }, []);

      useEffect(() => {
        if (!ytReady) return;
        
        if (!currentVideo) {
            if (playerRef.current) {
                playerRef.current.destroy();
                playerRef.current = null;
            }
            return;
        }

        const currentTimes = JSON.parse(localStorage.getItem('ytCloneTimes') || '{}');
        const startSeconds = currentTimes[currentVideo.id] || 0;

        const isPlaylist = currentVideo.type === 'playlist';
        const isLocalPlaylist = currentVideo.type === 'local_playlist';
        
        let playerVars = { autoplay: 1, start: startSeconds, enablejsapi: 1, playsinline: 1 };

        if (isPlaylist) {
            playerVars.listType = 'playlist';
            playerVars.list = currentVideo.listId;
        } else if (isLocalPlaylist) {
            playerVars.playlist = currentVideo.videoIds.slice(1).join(',');
        }

        if (!playerRef.current) {
            const wrapper = document.getElementById('yt-player-wrapper');
            if (wrapper && !document.getElementById('yt-player-instance')) {
                const div = document.createElement('div');
                div.id = 'yt-player-instance';
                wrapper.appendChild(div);

                playerRef.current = new window.YT.Player('yt-player-instance', {
                    height: '100%', width: '100%',
                    videoId: isLocalPlaylist ? currentVideo.videoIds[0] : (currentVideo.videoId || ''),
                    playerVars: playerVars,
                    events: {
                        onReady: (e) => { e.target.playVideo(); },
                        onStateChange: (e) => {
                            if (e.data === window.YT.PlayerState.PLAYING || e.data === window.YT.PlayerState.UNSTARTED || e.data === window.YT.PlayerState.CUED) {
                                // Extract Playlist Data for Right Sidebar
                                if (currentVideo.type.includes('playlist')) {
                                    const queue = e.target.getPlaylist();
                                    if (queue && queue.length > 0) {
                                        setPlaylistQueue(queue);
                                        setCurrentPlaylistIndex(e.target.getPlaylistIndex() || 0);
                                    }
                                }
                            }

                            if (e.data === window.YT.PlayerState.PLAYING) {
                                // --- AUTO TITLE & THUMBNAIL FETCH LOGIC ---
                                const vData = e.target.getVideoData();
                                const actualVideoId = vData?.video_id;

                                if (vData && (vData.title || actualVideoId)) {
                                    setVideos(prev => {
                                        let changed = false;
                                        const updated = prev.map(v => {
                                            if (v.id === currentVideo.id) {
                                                let newTitle = v.title;
                                                let newThumbnail = v.thumbnail;

                                                if (vData.title && (v.title === 'YouTube Video' || v.title === 'YouTube Playlist' || v.title === 'Custom Video' || v.title === '')) {
                                                    newTitle = vData.title;
                                                    changed = true;
                                                }
                                                if (actualVideoId && v.thumbnail.includes('placehold.co')) {
                                                    newThumbnail = `https://img.youtube.com/vi/${actualVideoId}/hqdefault.jpg`;
                                                    changed = true;
                                                }
                                                if(changed) return { ...v, title: newTitle, thumbnail: newThumbnail };
                                            }
                                            return v;
                                        });
                                        if(changed) localStorage.setItem('ytCloneVideos', JSON.stringify(updated));
                                        return changed ? updated : prev;
                                    });
                                }

                                timeIntervalRef.current = setInterval(() => {
                                    if (playerRef.current && playerRef.current.getCurrentTime) {
                                        const time = Math.floor(playerRef.current.getCurrentTime());
                                        const times = JSON.parse(localStorage.getItem('ytCloneTimes') || '{}');
                                        times[currentVideo.id] = time;
                                        localStorage.setItem('ytCloneTimes', JSON.stringify(times));
                                    }
                                }, 1000);
                            } else {
                                clearInterval(timeIntervalRef.current);
                            }
                        }
                    }
                });
            }
        } else {
            if (isPlaylist) {
                playerRef.current.loadPlaylist({ list: currentVideo.listId, listType: 'playlist', index: 0, startSeconds });
            } else if (isLocalPlaylist) {
                playerRef.current.loadPlaylist({ playlist: currentVideo.videoIds, index: 0, startSeconds });
            } else {
                playerRef.current.loadVideoById({ videoId: currentVideo.videoId, startSeconds });
            }
        }

        return () => clearInterval(timeIntervalRef.current);
      }, [currentVideo, ytReady]);

      const activateMiniplayer = () => {
        if (!playerRect) {
            const w = 384;
            const h = w * (9/16) + 40;
            setPlayerRect({ left: window.innerWidth - w - 24, top: window.innerHeight - h - 24, width: w, height: h });
        }
        setIsMiniplayer(true);
      };

      const playVideo = (video) => {
        setCurrentVideo(video);
        setLastWatched(video);
        setIsMiniplayer(false); 
        setPlaylistQueue([]); // Reset playlist UI when changing video
        setCurrentPlaylistIndex(0);

        const updatedHistory = [video, ...watchHistory.filter(v => v.id !== video.id)].slice(0, 20);
        setWatchHistory(updatedHistory);
        localStorage.setItem('ytCloneHistory', JSON.stringify(updatedHistory));
        localStorage.setItem('ytCloneLastWatched', JSON.stringify(video));
      };

      const deleteMedia = (e, id) => {
        e.stopPropagation();
        setConfirmState({ isOpen: true, message: 'আপনি কি নিশ্চিত যে এটি ডিলিট করতে চান?', targetId: id });
      };

      const executeDelete = () => {
        const updatedVideos = videos.filter(v => v.id !== confirmState.targetId);
        setVideos(updatedVideos);
        localStorage.setItem('ytCloneVideos', JSON.stringify(updatedVideos));
        if(currentVideo?.id === confirmState.targetId) {
            setCurrentVideo(null);
            setIsMiniplayer(false);
        }
        setConfirmState({ isOpen: false, message: '', targetId: null });
      };

      const handleAddSubmit = (e) => {
        e.preventDefault();
        const { videoId, listId, title: extractedTitle } = parseYouTubeInput(newMediaInput.link);
        
        if (!videoId && !listId) {
            setAlertState({ isOpen: true, message: 'দয়া করে একটি সঠিক ইউটিউব লিংক বা এমবেড কোড দিন।' });
            return;
        }

        const id = listId ? listId : videoId;
        const type = listId ? 'playlist' : 'video';
        
        let finalTitle = newMediaInput.title || extractedTitle;
        if (!finalTitle) finalTitle = type === 'playlist' ? 'YouTube Playlist' : 'YouTube Video';

        const thumbnail = videoId ? `https://img.youtube.com/vi/${videoId}/hqdefault.jpg` : 'https://placehold.co/640x360/222222/FFFFFF/png?text=YouTube+Playlist';

        const newMedia = {
            id: id, videoId, listId, type, title: finalTitle,
            channel: newMediaInput.channel || 'Added by User', views: '0 views', thumbnail,
            channelAvatar: `https://ui-avatars.com/api/?name=${newMediaInput.channel || 'User'}&background=random`,
        };

        const updatedVideos = [newMedia, ...videos];
        setVideos(updatedVideos);
        localStorage.setItem('ytCloneVideos', JSON.stringify(updatedVideos));
        setIsAddModalOpen(false);
        setNewMediaInput({ link: '', title: '', channel: '' });
      };

      const handleCreatePlaylist = (e) => {
        e.preventDefault();
        if(selectedVideoIds.length === 0) {
            setAlertState({ isOpen: true, message: 'অন্তত একটি ভিডিও নির্বাচন করুন।' });
            return;
        }
        
        const firstVid = videos.find(v => v.videoId === selectedVideoIds[0]);
        const newPlaylist = {
            id: 'local-list-' + Date.now(), type: 'local_playlist', title: newListTitle || 'My Playlist',
            videoIds: selectedVideoIds, thumbnail: firstVid ? firstVid.thumbnail : 'https://placehold.co/640x360/222222/FFFFFF/png?text=Playlist',
            channel: 'Created by You', channelAvatar: 'https://ui-avatars.com/api/?name=User&background=random',
            views: selectedVideoIds.length + ' videos'
        };
        
        const updated = [newPlaylist, ...videos];
        setVideos(updated);
        localStorage.setItem('ytCloneVideos', JSON.stringify(updated));
        setIsCreateListModalOpen(false);
        setNewListTitle('');
        setSelectedVideoIds([]);
      };

      const filteredVideos = videos.filter(video => video.title.toLowerCase().includes(searchQuery.toLowerCase()) || video.channel.toLowerCase().includes(searchQuery.toLowerCase()));

      const handleDragStart = (e) => {
        if (e.target.closest('button')) return;
        setIsDragging(true);
        const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
        setDragOffset({ x: clientX - playerRect.left, y: clientY - playerRect.top });
      };

      const handleResizeStart = (e, dir) => {
        e.stopPropagation(); e.preventDefault();
        const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
        setResizeState({ active: true, dir, startX: clientX, startY: clientY, startLeft: playerRect.left, startTop: playerRect.top, startWidth: playerRect.width, startHeight: playerRect.height });
      };

      useEffect(() => {
        const handleMove = (e) => {
          const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
          const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
          
          if (isDragging && playerRect) {
            setPlayerRect(prev => ({ ...prev, left: clientX - dragOffset.x, top: clientY - dragOffset.y }));
          } else if (resizeState.active) {
            const dx = clientX - resizeState.startX, dy = clientY - resizeState.startY;
            let { startLeft, startTop, startWidth, startHeight, dir } = resizeState;
            let newWidth = startWidth, newLeft = startLeft, newTop = startTop;

            if (dir.includes('e')) newWidth = startWidth + dx;
            else if (dir.includes('w')) { newWidth = startWidth - dx; newLeft = startLeft + dx; } 
            
            if (dir.includes('n')) {
                const videoH = (startHeight - dy) - 40;
                newWidth = videoH * (16/9);
                newTop = startTop + dy;
                newLeft = startLeft + (startWidth - newWidth) / 2;
            } else if (dir.includes('s')) {
                const videoH = (startHeight + dy) - 40;
                newWidth = videoH * (16/9);
                newLeft = startLeft + (startWidth - newWidth) / 2;
            }

            if (newWidth < 250) { newWidth = 250; if (dir.includes('w')) newLeft -= (250 - newWidth); }
            if (newWidth > 800) { newWidth = 800; if (dir.includes('w')) newLeft += (newWidth - 800); }

            const newHeight = newWidth * (9/16) + 40;
            if (dir.includes('n')) newTop = startTop + (startHeight - newHeight);
            setPlayerRect({ left: newLeft, top: newTop, width: newWidth, height: newHeight });
          }
        };

        const handleUp = () => { setIsDragging(false); setResizeState(prev => ({ ...prev, active: false })); };

        if (isDragging || resizeState.active) {
          window.addEventListener('mousemove', handleMove); window.addEventListener('mouseup', handleUp);
          window.addEventListener('touchmove', handleMove, { passive: false }); window.addEventListener('touchend', handleUp);
        }
        return () => {
          window.removeEventListener('mousemove', handleMove); window.removeEventListener('mouseup', handleUp);
          window.removeEventListener('touchmove', handleMove); window.removeEventListener('touchend', handleUp);
        };
      }, [isDragging, resizeState, dragOffset, playerRect]);

      return (
        <div className="min-h-screen flex flex-col relative overflow-hidden bg-[#0f0f0f]">
          {/* Header */}
          <header className="flex items-center justify-between px-4 py-2 sticky top-0 bg-[#0f0f0f] z-40 h-16 border-b border-white/10">
            <div className="flex items-center gap-4">
              <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 hover:bg-white/10 rounded-full transition-colors">
                <i className="fas fa-bars text-xl"></i>
              </button>
              <div className="flex items-center gap-2 cursor-pointer" onClick={() => { if (currentVideo) activateMiniplayer(); setActiveTab('home'); }}>
                <i className="fab fa-youtube text-red-600 text-3xl"></i>
                <span className="text-xl font-bold tracking-tighter hidden sm:block">YouTube</span>
              </div>
            </div>

            <div className="flex-1 max-w-2xl flex items-center ml-4 mr-4">
              <div className="flex w-full bg-[#121212] border border-white/20 rounded-full overflow-hidden focus-within:border-blue-500">
                <input 
                  type="text" 
                  placeholder="অনুসন্ধান করুন..." 
                  className="w-full bg-transparent px-4 py-2 outline-none text-white placeholder-gray-400"
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                />
                <button className="px-5 bg-white/10 hover:bg-white/20 transition-colors border-l border-white/20">
                  <i className="fas fa-search text-gray-300"></i>
                </button>
              </div>
            </div>

            <div className="flex items-center gap-2 sm:gap-3">
              <button onClick={() => setIsCreateListModalOpen(true)} className="flex items-center gap-2 px-3 py-1.5 bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 rounded-full transition-colors border border-blue-500/30">
                <i className="fas fa-folder-plus text-sm"></i><span className="text-sm font-semibold hidden md:block">প্লেলিস্ট বানান</span>
              </button>
              <button onClick={() => setIsAddModalOpen(true)} className="flex items-center gap-2 px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded-full transition-colors border border-white/20">
                <i className="fas fa-plus text-sm"></i><span className="text-sm font-semibold hidden md:block">যোগ করুন</span>
              </button>
            </div>
          </header>

          <div className="flex flex-1 overflow-hidden">
            <aside className={`${isSidebarOpen ? 'w-60' : 'w-20'} hidden md:flex flex-col bg-[#0f0f0f] transition-all duration-300 overflow-y-auto px-2 py-3 border-r border-white/10 custom-scrollbar`}>
              <SidebarItem icon={<i className="fas fa-home text-xl"></i>} label="হোম" isOpen={isSidebarOpen} active={activeTab === 'home' && !currentVideo} onClick={() => { setActiveTab('home'); if(currentVideo) activateMiniplayer(); }} />
              <SidebarItem icon={<i className="fab fa-youtube text-xl"></i>} label="শর্টস" isOpen={isSidebarOpen} />
              {isSidebarOpen && <hr className="border-white/20 my-3" />}
              <SidebarItem icon={<i className="fas fa-history text-xl"></i>} label="ইতিহাস" isOpen={isSidebarOpen} active={activeTab === 'history'} onClick={() => { setActiveTab('history'); if(currentVideo) activateMiniplayer(); }} />
            </aside>

            <main className="flex-1 overflow-y-auto bg-[#0f0f0f] relative custom-scrollbar">
              
              {/* PERSISTENT VIDEO PLAYER VIEW */}
              <div className={`max-w-[1600px] mx-auto p-4 flex-col lg:flex-row gap-6 ${(currentVideo && !isMiniplayer) ? 'flex' : 'absolute w-0 h-0 overflow-hidden invisible'}`}>
                <div className="flex-1 lg:w-2/3 flex flex-col relative">
                  {currentVideo && (
                    <div 
                      className={`${isMiniplayer ? 'fixed z-[100] flex flex-col overflow-visible visible' : 'w-full aspect-video relative'}`}
                      style={isMiniplayer && playerRect ? { left: `${playerRect.left}px`, top: `${playerRect.top}px`, width: `${playerRect.width}px`, height: `${playerRect.height}px` } : {}}
                    >
                      <div className={`w-full h-full flex flex-col relative rounded-xl overflow-hidden ${isMiniplayer ? 'bg-[#212121] shadow-2xl border border-gray-700' : 'bg-black shadow-lg'}`}>
                        <div className={`${isMiniplayer ? 'flex' : 'hidden'} h-10 flex-shrink-0 justify-between items-center px-3 bg-[#181818] cursor-move select-none z-10 border-b border-gray-700`} onMouseDown={handleDragStart} onTouchStart={handleDragStart}>
                          <div className="flex flex-col truncate pr-2 w-[75%]">
                            <span className="text-sm font-bold truncate text-white">
                                {currentVideoData?.type?.includes('playlist') && <i className="fas fa-list mr-2 text-gray-400"></i>}
                                {currentVideoData?.title}
                            </span>
                          </div>
                          <div className="flex gap-4 text-gray-400 items-center">
                            <button onClick={() => setIsMiniplayer(false)} className="hover:text-white" title="Expand"><i className="fas fa-expand-alt"></i></button>
                            <button onClick={() => { setCurrentVideo(null); setIsMiniplayer(false); }} className="hover:text-white" title="Close"><i className="fas fa-times text-lg"></i></button>
                          </div>
                        </div>

                        <div className="w-full flex-1 relative bg-black pointer-events-auto overflow-hidden">
                          {(isDragging || resizeState.active) && <div className="absolute inset-0 z-10 bg-transparent"></div>}
                          <div id="yt-player-wrapper" className="w-full h-full"></div>
                        </div>
                      </div>

                      {/* 8-Way Resize Handles */}
                      {isMiniplayer && (
                        <>
                          <div className="absolute -top-2 left-2 right-2 h-4 cursor-n-resize z-20" onMouseDown={(e) => handleResizeStart(e, 'n')} onTouchStart={(e) => handleResizeStart(e, 'n')} />
                          <div className="absolute -bottom-2 left-2 right-2 h-4 cursor-s-resize z-20" onMouseDown={(e) => handleResizeStart(e, 's')} onTouchStart={(e) => handleResizeStart(e, 's')} />
                          <div className="absolute top-2 bottom-2 -left-2 w-4 cursor-w-resize z-20" onMouseDown={(e) => handleResizeStart(e, 'w')} onTouchStart={(e) => handleResizeStart(e, 'w')} />
                          <div className="absolute top-2 bottom-2 -right-2 w-4 cursor-e-resize z-20" onMouseDown={(e) => handleResizeStart(e, 'e')} onTouchStart={(e) => handleResizeStart(e, 'e')} />
                          <div className="absolute -top-2 -left-2 w-6 h-6 cursor-nw-resize z-30" onMouseDown={(e) => handleResizeStart(e, 'nw')} onTouchStart={(e) => handleResizeStart(e, 'nw')} />
                          <div className="absolute -top-2 -right-2 w-6 h-6 cursor-ne-resize z-30" onMouseDown={(e) => handleResizeStart(e, 'ne')} onTouchStart={(e) => handleResizeStart(e, 'ne')} />
                          <div className="absolute -bottom-2 -left-2 w-6 h-6 cursor-sw-resize z-30" onMouseDown={(e) => handleResizeStart(e, 'sw')} onTouchStart={(e) => handleResizeStart(e, 'sw')} />
                          <div className="absolute -bottom-2 -right-2 w-6 h-6 cursor-se-resize z-30" onMouseDown={(e) => handleResizeStart(e, 'se')} onTouchStart={(e) => handleResizeStart(e, 'se')} />
                        </>
                      )}
                    </div>
                  )}

                  <div className={`${isMiniplayer ? 'hidden' : 'block'}`}>
                    <h1 className="text-xl md:text-2xl font-bold mt-4 mb-2">
                        {currentVideoData?.type?.includes('playlist') && <span className="bg-white/10 text-xs px-2 py-1 rounded mr-2 align-middle border border-white/20">প্লেলিস্ট</span>}
                        {currentVideoData?.title}
                    </h1>
                    <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                      <div className="flex items-center gap-3">
                        <img src={currentVideoData?.channelAvatar} alt={currentVideoData?.channel} className="w-10 h-10 rounded-full" />
                        <div>
                          <h3 className="font-bold text-sm">{currentVideoData?.channel}</h3>
                          <p className="text-xs text-gray-400">সাবস্ক্রাইবার অজানা</p>
                        </div>
                        <button className="bg-white text-black px-4 py-2 rounded-full font-bold ml-2 hover:bg-gray-200 transition">সাবস্ক্রাইব</button>
                      </div>
                      <div className="flex items-center gap-2">
                        <button onClick={activateMiniplayer} className="flex items-center gap-2 px-4 py-2 bg-white/10 rounded-full hover:bg-white/20 transition font-bold" title="Miniplayer">
                          <i className="fas fa-compress-alt"></i> মিনিপ্লেয়ার
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div className={`lg:w-1/3 w-full flex flex-col gap-3 ${isMiniplayer ? 'hidden' : 'flex'}`}>
                  
                  {/* Playlist View on Right Side */}
                  {playlistQueue.length > 0 && currentVideoData?.type.includes('playlist') && (
                      <div className="bg-[#212121] rounded-xl border border-white/10 flex flex-col max-h-[500px] shadow-lg mb-2">
                          <div className="p-4 border-b border-white/10 bg-[#181818] rounded-t-xl">
                              <h3 className="font-bold text-lg leading-tight">{currentVideoData.title}</h3>
                              <p className="text-xs text-gray-400 mt-1">{currentVideoData.channel} • {currentPlaylistIndex + 1} / {playlistQueue.length}</p>
                          </div>
                          <div className="overflow-y-auto flex-1 p-2 flex flex-col gap-1 custom-scrollbar">
                              {playlistQueue.map((vidId, index) => {
                                  const isPlaying = index === currentPlaylistIndex;
                                  const localVidInfo = videos.find(v => v.videoId === vidId);
                                  const title = localVidInfo ? localVidInfo.title : `ভিডিও ${index + 1}`;
                                  const channel = localVidInfo ? localVidInfo.channel : 'YouTube';

                                  return (
                                      <div 
                                        key={index} 
                                        onClick={() => playerRef.current?.playVideoAt(index)}
                                        className={`flex gap-3 p-2 rounded-lg cursor-pointer transition items-center ${isPlaying ? 'bg-white/20' : 'hover:bg-white/10'}`}
                                      >
                                          <div className="text-xs text-gray-400 w-4 text-center">
                                              {isPlaying ? <i className="fas fa-play text-white text-[10px]"></i> : index + 1}
                                          </div>
                                          <div className="w-24 h-14 flex-shrink-0 relative rounded overflow-hidden bg-black">
                                              <img src={`https://img.youtube.com/vi/${vidId}/mqdefault.jpg`} className="w-full h-full object-cover" />
                                          </div>
                                          <div className="flex flex-col justify-center overflow-hidden pr-2">
                                              <h4 className={`text-sm font-semibold line-clamp-2 leading-snug ${isPlaying ? 'text-white' : 'text-gray-300'}`}>{title}</h4>
                                              <p className="text-xs text-gray-400 mt-0.5 truncate">{channel}</p>
                                          </div>
                                      </div>
                                  )
                              })}
                          </div>
                      </div>
                  )}

                  <h3 className="font-bold text-lg mb-2 mt-2">আপনার জন্য প্রস্তাবিত</h3>
                  {videos.filter(v => v?.id !== currentVideo?.id).map(video => (
                    <div key={video.id} className="flex gap-2 cursor-pointer group relative" onClick={() => playVideo(video)}>
                      <div className="w-40 h-24 flex-shrink-0 relative rounded-lg overflow-hidden bg-gray-900 border border-white/10">
                        <img src={video.thumbnail} alt={video.title} className="w-full h-full object-cover group-hover:scale-105 transition duration-300" />
                        {video.type.includes('playlist') && (
                            <div className="absolute bottom-1 right-1 bg-black/80 text-xs px-1.5 py-0.5 rounded flex items-center gap-1">
                                <i className="fas fa-list text-[10px]"></i> Playlist
                            </div>
                        )}
                      </div>
                      <div className="flex flex-col pr-6">
                        <h4 className="text-sm font-semibold line-clamp-2 group-hover:text-blue-400">{video.title}</h4>
                        <p className="text-xs text-gray-400 mt-1">{video.channel}</p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* HOME / GRID VIEW */}
              <div className={`p-4 sm:p-6 lg:p-8 max-w-[1800px] mx-auto ${(!currentVideo || isMiniplayer) ? 'block' : 'hidden'}`}>
                
                {activeTab === 'home' && lastWatched && !searchQuery && (
                  <div className="mb-8 bg-gradient-to-r from-blue-900/40 to-purple-900/40 border border-white/10 rounded-2xl p-4 flex flex-col sm:flex-row items-center justify-between gap-4 shadow-xl">
                    <div className="flex items-center gap-4 w-full sm:w-auto">
                      <div className="w-32 aspect-video rounded-lg overflow-hidden flex-shrink-0 relative cursor-pointer border border-white/10 bg-gray-900" onClick={() => playVideo(lastWatched)}>
                        <img src={lastWatched.thumbnail} alt="Resume" className="w-full h-full object-cover" />
                        <div className="absolute inset-0 bg-black/40 flex items-center justify-center hover:bg-black/20">
                          <i className="fas fa-play-circle text-3xl text-white"></i>
                        </div>
                      </div>
                      <div>
                        <h3 className="text-sm text-blue-300 font-semibold mb-1 flex items-center gap-2">
                          <i className="fas fa-history"></i> রিজিউম (যেখান থেকে শেষ করেছিলেন)
                        </h3>
                        <h4 className="font-bold line-clamp-1">{lastWatched.title}</h4>
                        <p className="text-xs text-gray-400 mt-0.5 flex items-center gap-1">
                          {lastWatched.type.includes('playlist') && <i className="fas fa-list"></i>} {lastWatched.type.includes('playlist') ? 'Playlist' : 'Video'}
                        </p>
                      </div>
                    </div>
                    <button onClick={() => playVideo(lastWatched)} className="bg-white text-black px-6 py-2 rounded-full font-bold hover:bg-gray-200 transition">
                      প্লে করুন
                    </button>
                  </div>
                )}

                <h2 className="text-xl font-bold mb-6">
                  {activeTab === 'history' ? 'আপনার দেখার ইতিহাস' : (searchQuery ? `"${searchQuery}" এর ফলাফল` : 'প্রস্তাবিত ভিডিও ও প্লেলিস্ট')}
                </h2>

                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-x-4 gap-y-8">
                  {(activeTab === 'history' ? watchHistory : filteredVideos).map((video, index) => (
                    <div key={`${video.id}-${index}`} className="flex flex-col cursor-pointer group relative" onClick={() => playVideo(video)}>
                      <button 
                        onClick={(e) => deleteMedia(e, video.id)}
                        className="absolute top-2 right-2 bg-black/80 hover:bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition z-20 shadow-lg"
                        title="মুছে ফেলুন"
                      >
                        <i className="fas fa-trash text-sm"></i>
                      </button>
                      <div className="w-full aspect-video relative rounded-xl overflow-hidden mb-3 border border-white/10 bg-gray-900">
                        <img src={video.thumbnail} alt={video.title} className="w-full h-full object-cover group-hover:scale-105 transition duration-300" />
                        {video.type.includes('playlist') && (
                            <div className="absolute bottom-1.5 right-1.5 bg-black/80 text-xs px-2 py-0.5 rounded font-medium flex items-center gap-1">
                                <i className="fas fa-list"></i> Playlist
                            </div>
                        )}
                      </div>
                      <div className="flex gap-3 pr-2">
                        <img src={video.channelAvatar} alt={video.channel} className="w-9 h-9 rounded-full mt-1 flex-shrink-0" />
                        <div>
                          <h3 className="text-sm font-semibold line-clamp-2 group-hover:text-blue-400">{video.title}</h3>
                          <p className="text-sm text-gray-400 mt-1 hover:text-white transition">{video.channel}</p>
                          <p className="text-sm text-gray-400">{video.views}</p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </main>
          </div>

          {/* CUSTOM ALERT MODAL */}
          {alertState.isOpen && (
            <div className="fixed inset-0 z-[300] flex items-center justify-center bg-black/80 p-4 backdrop-blur-sm transition-opacity">
                <div className="bg-[#212121] rounded-2xl w-full max-w-sm border border-gray-700 shadow-2xl p-6 text-center transform transition-all scale-100">
                    <div className="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-500/20">
                        <i className="fas fa-exclamation-triangle text-2xl text-red-500"></i>
                    </div>
                    <h2 className="text-xl font-bold mb-2">সতর্কতা</h2>
                    <p className="text-gray-400 mb-6">{alertState.message}</p>
                    <button onClick={() => setAlertState({isOpen: false, message: ''})} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2.5 rounded-full font-bold transition w-full">
                        ঠিক আছে
                    </button>
                </div>
            </div>
          )}

          {/* CUSTOM CONFIRM MODAL */}
          {confirmState.isOpen && (
            <div className="fixed inset-0 z-[300] flex items-center justify-center bg-black/80 p-4 backdrop-blur-sm transition-opacity">
                <div className="bg-[#212121] rounded-2xl w-full max-w-sm border border-gray-700 shadow-2xl p-6 text-center transform transition-all scale-100">
                    <div className="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-500/20">
                        <i className="fas fa-trash-alt text-2xl text-red-500"></i>
                    </div>
                    <h2 className="text-xl font-bold mb-2">নিশ্চিত করুন</h2>
                    <p className="text-gray-400 mb-6">{confirmState.message}</p>
                    <div className="flex gap-3">
                        <button onClick={() => setConfirmState({isOpen: false, message: '', targetId: null})} className="flex-1 bg-white/10 hover:bg-white/20 text-white py-2.5 rounded-full font-bold transition">
                            বাতিল
                        </button>
                        <button onClick={executeDelete} className="flex-1 bg-red-600 hover:bg-red-500 text-white py-2.5 rounded-full font-bold transition">
                            ডিলিট করুন
                        </button>
                    </div>
                </div>
            </div>
          )}

          {/* ADD MEDIA MODAL */}
          {isAddModalOpen && (
            <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/80 p-4 backdrop-blur-sm">
                <div className="bg-[#212121] rounded-2xl w-full max-w-lg border border-gray-700 shadow-2xl">
                    <div className="flex justify-between items-center p-4 border-b border-gray-700">
                        <h2 className="text-xl font-bold">ভিডিও বা প্লেলিস্ট যোগ করুন</h2>
                        <button onClick={() => setIsAddModalOpen(false)} className="text-gray-400 hover:text-white"><i className="fas fa-times text-xl"></i></button>
                    </div>
                    <form onSubmit={handleAddSubmit} className="p-4 flex flex-col gap-4">
                        <div>
                            <label className="block text-sm text-gray-400 mb-1">ইউটিউব লিংক বা এমবেড কোড (বাধ্যতামূলক)</label>
                            <input type="text" required placeholder='যেমন: https://youtube.com/watch?v=...' className="w-full bg-[#121212] border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500" value={newMediaInput.link} onChange={(e) => setNewMediaInput({...newMediaInput, link: e.target.value})} />
                        </div>
                        <div>
                            <label className="block text-sm text-gray-400 mb-1">টাইটেল (খালি রাখলে নিজে থেকেই তৈরি হবে)</label>
                            <input type="text" placeholder="ভিডিও বা প্লেলিস্টের নাম" className="w-full bg-[#121212] border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500" value={newMediaInput.title} onChange={(e) => setNewMediaInput({...newMediaInput, title: e.target.value})} />
                        </div>
                        <div>
                            <label className="block text-sm text-gray-400 mb-1">চ্যানেলের নাম (ঐচ্ছিক)</label>
                            <input type="text" placeholder="চ্যানেলের নাম" className="w-full bg-[#121212] border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500" value={newMediaInput.channel} onChange={(e) => setNewMediaInput({...newMediaInput, channel: e.target.value})} />
                        </div>
                        <div className="flex justify-end gap-3 mt-4">
                            <button type="button" onClick={() => setIsAddModalOpen(false)} className="px-4 py-2 rounded-full font-bold hover:bg-white/10">বাতিল</button>
                            <button type="submit" className="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-full font-bold transition">যোগ করুন</button>
                        </div>
                    </form>
                </div>
            </div>
          )}

          {/* CREATE CUSTOM PLAYLIST MODAL */}
          {isCreateListModalOpen && (
            <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/80 p-4 backdrop-blur-sm">
                <div className="bg-[#212121] rounded-2xl w-full max-w-lg border border-gray-700 shadow-2xl">
                    <div className="flex justify-between items-center p-4 border-b border-gray-700">
                        <h2 className="text-xl font-bold">নতুন প্লেলিস্ট বানান</h2>
                        <button onClick={() => setIsCreateListModalOpen(false)} className="text-gray-400 hover:text-white"><i className="fas fa-times text-xl"></i></button>
                    </div>
                    <form onSubmit={handleCreatePlaylist} className="p-4 flex flex-col gap-4">
                        <div>
                            <label className="block text-sm text-gray-400 mb-1">প্লেলিস্টের নাম</label>
                            <input type="text" required placeholder="যেমন: My Favorite Videos" className="w-full bg-[#121212] border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500" value={newListTitle} onChange={(e) => setNewListTitle(e.target.value)} />
                        </div>
                        <div>
                            <label className="block text-sm text-gray-400 mb-1">ভিডিও সিলেক্ট করুন</label>
                            <div className="max-h-60 overflow-y-auto bg-[#121212] rounded-lg p-2 flex flex-col gap-1 border border-gray-600 custom-scrollbar">
                                {videos.filter(v => v.type === 'video').length === 0 && <p className="text-center text-gray-400 py-4 text-sm">কোনো সিঙ্গেল ভিডিও নেই। আগে ভিডিও যোগ করুন!</p>}
                                {videos.filter(v => v.type === 'video').map(v => (
                                    <label key={v.id} className="flex items-center gap-3 p-2 hover:bg-white/10 rounded cursor-pointer transition">
                                        <input type="checkbox" checked={selectedVideoIds.includes(v.videoId)} onChange={(e) => { if(e.target.checked) setSelectedVideoIds([...selectedVideoIds, v.videoId]); else setSelectedVideoIds(selectedVideoIds.filter(id => id !== v.videoId)); }} className="w-4 h-4 rounded border-gray-500 bg-black cursor-pointer" />
                                        <img src={v.thumbnail} className="w-12 h-8 object-cover rounded" />
                                        <span className="text-sm truncate select-none">{v.title}</span>
                                    </label>
                                ))}
                            </div>
                            <p className="text-xs text-gray-400 mt-2 text-right">{selectedVideoIds.length} টি ভিডিও সিলেক্ট করা হয়েছে</p>
                        </div>
                        <div className="flex justify-end gap-3 mt-2">
                            <button type="button" onClick={() => setIsCreateListModalOpen(false)} className="px-4 py-2 rounded-full font-bold hover:bg-white/10">বাতিল</button>
                            <button type="submit" className="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-full font-bold transition">সেভ করুন</button>
                        </div>
                    </form>
                </div>
            </div>
          )}
        </div>
      );
    }

    function SidebarItem({ icon, label, isOpen, active, onClick }) {
      return (
        <div onClick={onClick} className={`flex items-center ${isOpen ? 'justify-start px-3' : 'justify-center flex-col'} py-2.5 my-1 rounded-xl cursor-pointer transition-colors ${active ? 'bg-white/10 font-bold' : 'hover:bg-white/10'}`}>
          <div className={`flex items-center justify-center ${isOpen ? 'mr-4' : 'mb-1'} ${active ? 'text-white' : 'text-gray-200'}`}>{icon}</div>
          <span className={`${isOpen ? 'text-sm' : 'text-[10px]'} ${active ? 'text-white font-semibold' : 'text-gray-200'}`}>{label}</span>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
